<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Goal Ninja ‚Äî Get Started</title>
    <script src="./goal-ninja-data.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #1a1a1a;
            --text-secondary: #666;
            --accent: #E67E22;
            --accent-light: rgba(230, 126, 34, 0.1);
            --success: #22c55e;
            --danger: #ef4444;
            --border: #e5e5e5;
            --radius: 16px;
            --radius-sm: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            background: #f5f5f5;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Phone Frame */
        .phone-frame {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            background: var(--bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 500px) {
            body { background: #e5e5e5; }
            .phone-frame {
                width: 390px;
                height: 844px;
                max-height: 95vh;
                border-radius: 40px;
                box-shadow: 0 25px 80px rgba(0,0,0,0.15);
            }
        }

        /* Progress Bar */
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--border);
            z-index: 100;
        }
        .progress-bar .fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.4s ease;
            border-radius: 0 2px 2px 0;
        }

        /* Back Button */
        .back-btn {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 101;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.06);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .back-btn:active { transform: scale(0.92); }
        .back-btn svg { width: 18px; height: 18px; stroke: var(--text); }
        .back-btn.hidden { display: none; }

        /* Carousel */
        .carousel {
            flex: 1;
            display: flex;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            min-height: 0;
        }
        .screen {
            min-width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 28px 40px;
            overflow-y: auto;
        }

        /* Shared Typography */
        .screen h1 {
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            line-height: 1.25;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        .screen h2 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            line-height: 1.25;
            margin-bottom: 8px;
            letter-spacing: -0.2px;
        }
        .screen .subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
            margin-bottom: 24px;
            max-width: 320px;
        }

        /* Ninja Image */
        .ninja-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
            margin-bottom: 20px;
            animation: ninjaFloat 2.5s ease-in-out infinite;
        }
        .ninja-img.small { width: 100px; height: 100px; }
        @keyframes ninjaFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            max-width: 320px;
            padding: 16px 24px;
            background: var(--text);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: -0.2px;
            margin-top: auto;
        }
        .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.4; pointer-events: none; }
        .btn-primary.accent { background: var(--accent); }

        /* Text Button */
        .btn-text {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 12px;
            margin-top: 8px;
        }
        .btn-text:active { opacity: 0.6; }

        /* Text Input */
        .text-input {
            width: 100%;
            max-width: 320px;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 17px;
            font-weight: 500;
            background: #ffffff;
            color: var(--text);
            text-align: center;
            transition: border-color 0.2s;
            outline: none;
            margin-bottom: 24px;
        }
        .text-input:focus { border-color: var(--accent); }
        .text-input::placeholder { color: #ccc; }

        /* Selection Cards */
        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 340px;
            margin-bottom: 24px;
        }
        .card-grid.single-col {
            grid-template-columns: 1fr;
        }
        .select-card {
            background: #ffffff;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            user-select: none;
        }
        .select-card:active { transform: scale(0.97); }
        .select-card.selected {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        .select-card .card-emoji {
            font-size: 28px;
            margin-bottom: 6px;
            display: block;
        }
        .select-card .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }
        .select-card .card-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.3;
        }
        .select-card.single-col-card {
            display: flex;
            align-items: center;
            gap: 14px;
            text-align: left;
            padding: 14px 16px;
        }
        .select-card.single-col-card .card-emoji {
            font-size: 24px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        /* Ninja Response Bubble */
        .ninja-response {
            background: var(--accent-light);
            border-radius: 20px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--accent);
            text-align: center;
            margin-bottom: 16px;
            max-width: 300px;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s ease;
        }
        .ninja-response.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Plan Card */
        .plan-card {
            background: #ffffff;
            border-radius: var(--radius);
            padding: 20px;
            width: 100%;
            max-width: 340px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }
        .plan-card .plan-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .plan-card .plan-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .plan-card .plan-name {
            font-size: 18px;
            font-weight: 700;
        }
        .plan-card .plan-detail {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .plan-card .plan-detail:last-child { border-bottom: none; }
        .plan-card .plan-label { color: var(--text-secondary); }
        .plan-card .plan-value { font-weight: 600; }
        .plan-habits-list {
            margin-top: 12px;
        }
        .plan-habit-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .plan-habit-item:last-child { border-bottom: none; }
        .plan-habit-name { font-weight: 500; }
        .plan-habit-penalty { color: var(--accent); font-weight: 600; }

        /* Customize Form */
        .form-group {
            width: 100%;
            max-width: 340px;
            margin-bottom: 16px;
        }
        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }
        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 500;
            background: #ffffff;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--accent); }

        /* Icon Grid */
        .icon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .icon-option {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #ffffff;
        }
        .icon-option:active { transform: scale(0.92); }
        .icon-option.selected {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        /* Habit Edit Item */
        .habit-edit-item {
            background: #ffffff;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            margin-bottom: 10px;
        }
        .habit-edit-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .habit-edit-name {
            flex: 1;
            border: none;
            font-size: 15px;
            font-weight: 500;
            background: transparent;
            color: var(--text);
            outline: none;
        }
        .habit-edit-penalty {
            width: 60px;
            text-align: center;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            outline: none;
            background: #ffffff;
        }
        .habit-edit-penalty:focus { border-color: var(--accent); }
        .habit-remove-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: rgba(239,68,68,0.1);
            color: var(--danger);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-habit-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .add-habit-btn:active { border-color: var(--accent); color: var(--accent); }

        /* Habit Frequency Row */
        .habit-freq-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }
        .habit-freq-row .freq-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .habit-freq-num {
            width: 44px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 5px 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            background: #ffffff;
            text-align: center;
            outline: none;
            font-family: inherit;
        }
        .habit-freq-num:focus { border-color: var(--accent); }
        .habit-freq-unit {
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 5px 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            background: #ffffff;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            -webkit-appearance: none;
        }
        .habit-freq-unit:focus { border-color: var(--accent); }

        /* Habit Edit Icon */
        .habit-edit-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .habit-edit-icon:active { transform: scale(0.92); }

        /* Habit Icon Picker Overlay */
        .habit-icon-picker-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }
        .habit-icon-picker-overlay.active { display: flex; }
        .habit-icon-picker-modal {
            background: #ffffff;
            border-radius: 20px 20px 0 0;
            padding: 16px 20px 28px;
            width: 100%;
            max-width: 390px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .habit-icon-picker-overlay.active .habit-icon-picker-modal {
            transform: translateY(0);
        }
        .habit-icon-picker-handle {
            width: 36px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 12px;
        }
        .habit-icon-picker-title {
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
        }
        .habit-icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .habit-icon-pick-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 4px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        .habit-icon-pick-item:active { transform: scale(0.95); }
        .habit-icon-pick-item.selected {
            background: var(--accent-light);
            border-color: var(--accent);
        }
        .habit-icon-pick-circle {
            width: 40px;
            height: 40px;
            background: var(--bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .habit-icon-pick-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        /* Textarea */
        textarea.form-input {
            font-family: inherit;
            resize: none;
            line-height: 1.5;
        }

        /* Settings Card */
        .settings-card {
            background: #ffffff;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            overflow: hidden;
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            position: relative;
        }
        .settings-row + .settings-row {
            border-top: 1px solid var(--border);
        }
        .settings-row .settings-label {
            font-size: 14px;
            font-weight: 500;
        }
        .settings-row .settings-value {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .settings-row input[type="time"],
        .settings-row input[type="date"] {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Duration Pills */
        .pill-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pill {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            background: #ffffff;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .pill:active { transform: scale(0.95); }
        .pill.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent);
        }

        /* Target Slider */
        .target-slider-wrap {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .target-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }
        .target-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(230,126,34,0.3);
        }
        .target-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            min-width: 48px;
            text-align: right;
        }

        /* Pro Badge */
        .pro-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            vertical-align: middle;
            margin-left: 6px;
        }

        /* Commitment Checks */
        .commit-list {
            width: 100%;
            max-width: 340px;
            margin-bottom: 24px;
        }
        .commit-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: #ffffff;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 2px solid var(--border);
        }
        .commit-item.checked {
            border-color: var(--success);
            background: rgba(34,197,94,0.05);
        }
        .commit-check {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .commit-item.checked .commit-check {
            background: var(--success);
            border-color: var(--success);
        }
        .commit-check svg { opacity: 0; transition: opacity 0.2s; }
        .commit-item.checked .commit-check svg { opacity: 1; }
        .commit-text { font-size: 14px; font-weight: 500; line-height: 1.4; }

        /* Feature Compare */
        .compare-table {
            width: 100%;
            max-width: 340px;
            margin-bottom: 20px;
        }
        .compare-header {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 10px 0;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }
        .compare-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 12px 0;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .compare-row .feature { font-weight: 500; }
        .compare-row .check { text-align: center; font-size: 16px; }
        .compare-row .check.yes { color: var(--success); }
        .compare-row .check.no { color: #ddd; }
        .compare-row .check.pro { color: var(--accent); }

        /* Social Proof Screen */
        .screen-dark {
            background: var(--text);
            color: white;
        }
        .screen-dark .subtitle { color: rgba(255,255,255,0.6); }
        .stat-big {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 4px;
        }

        /* Calculating Spinner */
        .calc-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .calc-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            inset: 0;
            transition: opacity 0.4s;
        }
        .calc-wrap.hidden { opacity: 0; pointer-events: none; }

        /* Success Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            top: -20px;
            width: 10px;
            height: 14px;
            border-radius: 2px;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Summary Card */
        .summary-card {
            background: #ffffff;
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 340px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 24px;
        }
        .summary-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 28px;
        }
        .summary-goal-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        .summary-stat {
            text-align: center;
        }
        .summary-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }
        .summary-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Quick Win Check-in */
        .qw-habit {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #ffffff;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            width: 100%;
            max-width: 340px;
            transition: all 0.2s;
        }
        .qw-habit.done {
            border-color: var(--success);
            background: rgba(34,197,94,0.05);
        }
        .qw-habit-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .qw-habit-name { font-size: 15px; font-weight: 500; }
        .qw-check-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .qw-check-btn:active { transform: scale(0.9); }
        .qw-habit.done .qw-check-btn {
            background: var(--success);
            border-color: var(--success);
        }

        /* Scrollable screen override */
        .screen.scrollable {
            justify-content: flex-start;
            padding-top: 64px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .screen.scrollable .btn-primary {
            margin-top: 20px;
            flex-shrink: 0;
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
<div class="phone-frame">
    <!-- Progress Bar -->
    <div class="progress-bar"><div class="fill" id="progressFill" style="width: 0%"></div></div>

    <!-- Back Button -->
    <button class="back-btn hidden" id="backBtn" onclick="goBack()">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
    </button>

    <!-- Carousel -->
    <div class="carousel" id="carousel">

        <!-- ==================== SCREEN 1: WELCOME ==================== -->
        <div class="screen" id="screen1">
            <img src="../ninja-poses/ninja-action.png" alt="Goal Ninja" class="ninja-img">
            <h1>Welcome to Goal Ninja</h1>
            <p class="subtitle">Let's build a plan that's made for you.</p>
            <button class="btn-primary" onclick="goNext()">Let's Go</button>
        </div>

        <!-- ==================== SCREEN 2: NAME ==================== -->
        <div class="screen" id="screen2">
            <img src="../ninja-poses/ninja-wealth.png" alt="Ninja" class="ninja-img small">
            <h2>First, what should we call you?</h2>
            <p class="subtitle">We'll use this to personalize your experience.</p>
            <input type="text" class="text-input" id="nameInput" placeholder="Your name" maxlength="24" autocomplete="off" oninput="onNameInput()">
            <button class="btn-primary" id="nameContinueBtn" onclick="saveName(); goNext()">Continue</button>
            <button class="btn-text" onclick="skipName(); goNext()">Skip</button>
        </div>

        <!-- ==================== SCREEN 3: GOAL AREA ==================== -->
        <div class="screen scrollable" id="screen3">
            <h2 id="goalAreaTitle">What do you want to work on?</h2>
            <p class="subtitle">Pick as many as you like. We'll start with one.</p>
            <div class="card-grid" id="goalAreaGrid">
                <div class="select-card" data-area="fitness" onclick="toggleArea(this)">
                    <span class="card-emoji">üèãÔ∏è</span>
                    <div class="card-title">Get Fit</div>
                    <div class="card-desc">Exercise, diet, health</div>
                </div>
                <div class="select-card" data-area="learning" onclick="toggleArea(this)">
                    <span class="card-emoji">üìö</span>
                    <div class="card-title">Learn Something</div>
                    <div class="card-desc">Reading, study, skills</div>
                </div>
                <div class="select-card" data-area="saving" onclick="toggleArea(this)">
                    <span class="card-emoji">üí∞</span>
                    <div class="card-title">Save Money</div>
                    <div class="card-desc">Spending, budgeting</div>
                </div>
                <div class="select-card" data-area="mindfulness" onclick="toggleArea(this)">
                    <span class="card-emoji">üßò</span>
                    <div class="card-title">Be Mindful</div>
                    <div class="card-desc">Meditation, sleep, screen time</div>
                </div>
                <div class="select-card" data-area="breaking" onclick="toggleArea(this)">
                    <span class="card-emoji">üìµ</span>
                    <div class="card-title">Break Bad Habits</div>
                    <div class="card-desc">Social media, junk food</div>
                </div>
                <div class="select-card" data-area="routine" onclick="toggleArea(this)">
                    <span class="card-emoji">‚ú®</span>
                    <div class="card-title">Build a Routine</div>
                    <div class="card-desc">Morning routine, daily structure</div>
                </div>
            </div>
            <button class="btn-primary" id="goalAreaBtn" disabled onclick="goNext()">Continue</button>
        </div>

        <!-- ==================== SCREEN 4: EXPERIENCE ==================== -->
        <div class="screen" id="screen4">
            <img src="../ninja-poses/ninja-mentor.png" alt="Ninja" class="ninja-img small" id="expNinja">
            <div class="ninja-response" id="expResponse"></div>
            <h2>Have you tried habit tracking before?</h2>
            <p class="subtitle">No wrong answer ‚Äî this helps us tailor your experience.</p>
            <div class="card-grid single-col" id="expGrid">
                <div class="select-card single-col-card" data-exp="new" onclick="selectExp(this)">
                    <span class="card-emoji">üÜï</span>
                    <div>
                        <div class="card-title">I'm new to this</div>
                        <div class="card-desc">Haven't really tracked habits before</div>
                    </div>
                </div>
                <div class="select-card single-col-card" data-exp="tried" onclick="selectExp(this)">
                    <span class="card-emoji">üì±</span>
                    <div>
                        <div class="card-title">I've tried apps before</div>
                        <div class="card-desc">But couldn't stay consistent</div>
                    </div>
                </div>
                <div class="select-card single-col-card" data-exp="pro" onclick="selectExp(this)">
                    <span class="card-emoji">üí™</span>
                    <div>
                        <div class="card-title">I'm a pro</div>
                        <div class="card-desc">I just need better accountability</div>
                    </div>
                </div>
            </div>
            <button class="btn-primary" id="expBtn" disabled onclick="goNext()">Continue</button>
        </div>

        <!-- ==================== SCREEN 5: PAIN POINTS ==================== -->
        <div class="screen scrollable" id="screen5">
            <h2>What usually gets in the way?</h2>
            <p class="subtitle">Pick all that apply ‚Äî we'll help you beat them.</p>
            <div class="card-grid single-col" id="painGrid">
                <div class="select-card single-col-card" data-pain="motivation" onclick="togglePain(this)">
                    <span class="card-emoji">üò§</span>
                    <div>
                        <div class="card-title">I lose motivation</div>
                        <div class="card-desc">Give up after a few days</div>
                    </div>
                </div>
                <div class="select-card single-col-card" data-pain="streak" onclick="togglePain(this)">
                    <span class="card-emoji">üìâ</span>
                    <div>
                        <div class="card-title">Breaking a streak feels like failure</div>
                        <div class="card-desc">One miss and I quit entirely</div>
                    </div>
                </div>
                <div class="select-card single-col-card" data-pain="consequences" onclick="togglePain(this)">
                    <span class="card-emoji">ü§∑</span>
                    <div>
                        <div class="card-title">No real consequences</div>
                        <div class="card-desc">Nothing happens when I skip</div>
                    </div>
                </div>
                <div class="select-card single-col-card" data-pain="forget" onclick="togglePain(this)">
                    <span class="card-emoji">‚è∞</span>
                    <div>
                        <div class="card-title">I forget or get too busy</div>
                        <div class="card-desc">Life gets in the way</div>
                    </div>
                </div>
            </div>
            <button class="btn-primary" id="painBtn" disabled onclick="goNext()">Continue</button>
        </div>

        <!-- ==================== SCREEN 6: SOCIAL PROOF ==================== -->
        <div class="screen screen-dark" id="screen6">
            <img src="../ninja-poses/ninja-bag.png" alt="Ninja" class="ninja-img">
            <div class="stat-big">95%</div>
            <h2 style="color: white; margin-bottom: 12px;">of people reach their goals when real stakes are involved</h2>
            <p class="subtitle">That's why Goal Ninja turns missed habits into savings.</p>
            <button class="btn-primary accent" onclick="goNext()" style="margin-top: auto;">That Makes Sense</button>
        </div>

        <!-- ==================== SCREEN 7: PERSONALIZED PLAN ==================== -->
        <div class="screen scrollable" id="screen7" style="position: relative;">
            <!-- Calculating state -->
            <div class="calc-wrap" id="calcWrap">
                <div class="calc-spinner"></div>
                <h2>Building your plan...</h2>
                <p class="subtitle" style="margin-top: 8px;">Analyzing your answers</p>
            </div>
            <!-- Result (hidden initially) -->
            <div id="planResult" style="display: none; width: 100%; flex-direction: column; align-items: center;">
                <img src="../ninja-poses/ninja-thumbsup.png" alt="Ninja" class="ninja-img small">
                <h2 id="planTitle">Here's your plan</h2>
                <p class="subtitle">We created this based on your answers. You can customize it next.</p>
                <div class="plan-card" id="planCard"></div>
                <button class="btn-primary" onclick="goNext()">Customize My Plan</button>
            </div>
        </div>

        <!-- ==================== SCREEN 8: CUSTOMIZE GOAL ==================== -->
        <div class="screen scrollable" id="screen8">
            <h2>Customize Your Goal</h2>
            <p class="subtitle">Edit anything ‚Äî make it yours.</p>

            <div class="form-group">
                <label class="form-label">Goal Name</label>
                <input type="text" class="form-input" id="customGoalName" maxlength="40">
            </div>

            <div class="form-group">
                <label class="form-label">Description <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--text-secondary);">(optional)</span></label>
                <textarea class="form-input" id="customGoalDesc" placeholder="Add notes about your goal..." rows="2" style="resize:none;min-height:56px;"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Icon</label>
                <div class="icon-grid" id="iconGrid"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Habits</label>
                <div id="habitsEditList"></div>
                <button class="add-habit-btn" onclick="addHabitRow()">+ Add Habit</button>
            </div>

            <div class="form-group">
                <label class="form-label">Duration</label>
                <div class="pill-row" id="durationRow">
                    <div class="pill" data-dur="7" onclick="selectDuration(this)">7 days</div>
                    <div class="pill selected" data-dur="30" onclick="selectDuration(this)">30 days</div>
                    <div class="pill" data-dur="90" onclick="selectDuration(this)">90 days</div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Target</label>
                <div class="target-slider-wrap">
                    <input type="range" class="target-slider" id="targetSlider" min="50" max="100" value="80" oninput="updateTargetLabel()">
                    <span class="target-value" id="targetValue">80%</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Settings</label>
                <div class="settings-card">
                    <div class="settings-row">
                        <span class="settings-label">Daily Reminder</span>
                        <span class="settings-value" id="onbReminderDisplay">9:00 PM</span>
                        <input type="time" id="onbReminderInput" value="21:00" onchange="onOnbReminderChange(this.value)">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Start Date</span>
                        <span class="settings-value" id="onbStartDateDisplay">Today</span>
                        <input type="date" id="onbStartDateInput" onchange="onOnbStartDateChange(this.value)">
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="createGoalAndContinue()">Create Goal</button>
        </div>

        <!-- ==================== SCREEN 9: COMMITMENT ==================== -->
        <div class="screen" id="screen9">
            <img src="../ninja-poses/ninja-focus.png" alt="Ninja" class="ninja-img small">
            <h2 id="commitTitle">Make it official</h2>
            <p class="subtitle">Your commitment to yourself</p>
            <div class="commit-list">
                <div class="commit-item checked" onclick="toggleCommit(this)">
                    <div class="commit-check">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                    </div>
                    <span class="commit-text">I'll check in on my habits daily</span>
                </div>
                <div class="commit-item checked" onclick="toggleCommit(this)">
                    <div class="commit-check">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                    </div>
                    <span class="commit-text">I understand missed habits add to my savings</span>
                </div>
                <div class="commit-item checked" onclick="toggleCommit(this)">
                    <div class="commit-check">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
                    </div>
                    <span class="commit-text">I'm ready to build habits that stick</span>
                </div>
            </div>
            <button class="btn-primary" onclick="goNext()">I'm Ready</button>
        </div>

        <!-- ==================== SCREEN 10: PRO TEASER ==================== -->
        <div class="screen scrollable" id="screen10">
            <img src="../ninja-poses/ninja-wealth.png" alt="Ninja" class="ninja-img small">
            <h2>Unlock your full potential</h2>
            <p class="subtitle">Ninja Elite gives you the edge</p>

            <div class="compare-table">
                <div class="compare-header">
                    <span></span>
                    <span style="text-align:center;">Free</span>
                    <span style="text-align:center;">Elite ‚ú®</span>
                </div>
                <div class="compare-row">
                    <span class="feature">Goals</span>
                    <span class="check yes">Up to 3</span>
                    <span class="check pro">Unlimited</span>
                </div>
                <div class="compare-row">
                    <span class="feature">Analytics</span>
                    <span class="check yes">Basic</span>
                    <span class="check pro">Full</span>
                </div>
                <div class="compare-row">
                    <span class="feature">Withdrawal Fee</span>
                    <span class="check yes">10%</span>
                    <span class="check pro">5%</span>
                </div>
                <div class="compare-row">
                    <span class="feature">Custom Frequency</span>
                    <span class="check no">‚úï</span>
                    <span class="check pro">‚úì</span>
                </div>
                <div class="compare-row">
                    <span class="feature">Priority Support</span>
                    <span class="check no">‚úï</span>
                    <span class="check pro">‚úì</span>
                </div>
            </div>

            <p style="font-size: 13px; color: var(--text-secondary); text-align: center; margin-bottom: 16px;">Join the waitlist for Ninja Elite ‚Äî launching soon</p>

            <button class="btn-primary accent" onclick="proInterest(true); goNext()">Notify Me When Pro Launches</button>
            <button class="btn-text" onclick="proInterest(false); goNext()">Maybe Later</button>
        </div>

        <!-- ==================== SCREEN 11: SUCCESS ==================== -->
        <div class="screen" id="screen11">
            <img src="../ninja-poses/ninja-thumbsup.png" alt="Ninja" class="ninja-img" id="successNinja">
            <h1 id="successTitle">You're all set! üéâ</h1>
            <p class="subtitle">Your first goal is live. Let's make it count.</p>
            <div class="summary-card" id="summaryCard"></div>
            <button class="btn-primary" onclick="goNext()">Start Day 1 ‚Üí</button>
        </div>

        <!-- ==================== SCREEN 12: QUICK WIN ==================== -->
        <div class="screen scrollable" id="screen12">
            <img src="../ninja-poses/ninja-streak.png" alt="Ninja" class="ninja-img small" id="qwNinja">
            <h2>One last thing ‚Äî let's start strong</h2>
            <p class="subtitle" id="qwSubtitle">Check in on today's habits to get your first win!</p>
            <div id="qwHabitsList" style="width: 100%; max-width: 340px;"></div>
            <button class="btn-primary" onclick="finishOnboarding()" style="margin-top: 20px;">Go to Dashboard ‚Üí</button>
        </div>

    </div><!-- /carousel -->

    <!-- Habit Icon Picker Modal -->
    <div class="habit-icon-picker-overlay" id="habitIconPickerOverlay" onclick="closeHabitIconPicker(event)">
        <div class="habit-icon-picker-modal">
            <div class="habit-icon-picker-handle"></div>
            <div class="habit-icon-picker-title">Choose Icon</div>
            <div class="habit-icon-picker-grid" id="habitIconPickerGrid"></div>
        </div>
    </div>

</div><!-- /phone-frame -->

<script>
// ============================
// STATE
// ============================
var currentScreen = 0;
var totalScreens = 12;
var userName = '';
var userGoalAreas = [];
var userExperience = '';
var userPainPoints = [];
var selectedIcon = 'target';
var selectedDuration = 30;
var selectedReminder = '21:00';
var selectedStartDate = '';
var createdGoalId = null;
var createdHabitIds = [];
var activeHabitIconTarget = null;

// Goal templates by area
var goalTemplates = {
    fitness:     { name: 'Fitness Challenge',    icon: 'exercise', emoji: 'üèãÔ∏è', habits: [{ name: 'Morning Workout', icon: 'exercise', penalty: 5 }, { name: 'Drink 2L Water', icon: 'water', penalty: 3 }, { name: 'No Junk Food', icon: 'food', penalty: 5 }] },
    learning:    { name: 'Learning Sprint',      icon: 'book',     emoji: 'üìö', habits: [{ name: 'Study 30 Min', icon: 'book', penalty: 5 }, { name: 'Read 20 Pages', icon: 'book', penalty: 3 }] },
    saving:      { name: 'Money Saver',          icon: 'money',    emoji: 'üí∞', habits: [{ name: 'Pack Lunch', icon: 'money', penalty: 10 }, { name: 'No Impulse Buys', icon: 'shopping', penalty: 5 }] },
    mindfulness: { name: 'Mindfulness Journey',  icon: 'meditation', emoji: 'üßò', habits: [{ name: 'Meditate 10 Min', icon: 'meditation', penalty: 3 }, { name: 'No Phone Before Bed', icon: 'phone', penalty: 5 }] },
    breaking:    { name: 'Digital Detox',        icon: 'phone',    emoji: 'üìµ', habits: [{ name: 'No Social Media', icon: 'phone', penalty: 5 }, { name: 'No TikTok', icon: 'phone', penalty: 5 }] },
    routine:     { name: 'Morning Routine',      icon: 'sun',      emoji: '‚ú®', habits: [{ name: 'Wake Up Early', icon: 'sun', penalty: 5 }, { name: 'Make Bed', icon: 'target', penalty: 2 }, { name: 'Healthy Breakfast', icon: 'food', penalty: 3 }] }
};

// Available icons for icon picker
var iconIds = ['target', 'exercise', 'book', 'money', 'meditation', 'phone', 'food', 'water', 'sun', 'sleep', 'coffee', 'shopping'];

// ============================
// NAVIGATION
// ============================
function goTo(idx) {
    if (idx < 0 || idx >= totalScreens) return;
    currentScreen = idx;
    document.getElementById('carousel').style.transform = 'translateX(-' + (currentScreen * 100) + '%)';
    
    // Progress bar
    var pct = ((currentScreen) / (totalScreens - 1)) * 100;
    document.getElementById('progressFill').style.width = pct + '%';
    
    // Back button: show on screens 1-7, hide on welcome (0) and post-creation (8+)
    var backBtn = document.getElementById('backBtn');
    if (currentScreen === 0 || currentScreen >= 8) {
        backBtn.classList.add('hidden');
    } else {
        backBtn.classList.remove('hidden');
    }
    // White style for dark screen (Social Proof)
    if (currentScreen === 5) {
        backBtn.style.background = 'rgba(255,255,255,0.15)';
        backBtn.querySelector('svg').style.stroke = 'white';
    } else {
        backBtn.style.background = '';
        backBtn.querySelector('svg').style.stroke = '';
    }

    // Screen-specific triggers
    if (currentScreen === 6) triggerPlanAnimation();
    if (currentScreen === 10) triggerSuccess();
}

function goNext() { goTo(currentScreen + 1); }
function goBack() { goTo(currentScreen - 1); }

// ============================
// SCREEN 2: NAME
// ============================
function onNameInput() {
    var val = document.getElementById('nameInput').value.trim();
    document.getElementById('nameContinueBtn').disabled = val.length === 0;
}

function saveName() {
    userName = document.getElementById('nameInput').value.trim() || 'Ninja';
    localStorage.setItem('goalNinjaUserName', userName);
    applyName();
}

function skipName() {
    userName = 'Ninja';
    localStorage.setItem('goalNinjaUserName', userName);
    applyName();
}

function applyName() {
    // Update dynamic name references
    document.getElementById('goalAreaTitle').textContent = 'What do you want to work on, ' + userName + '?';
    document.getElementById('commitTitle').textContent = 'Make it official, ' + userName;
    document.getElementById('planTitle').textContent = userName + ', here\'s your plan';
    document.getElementById('successTitle').textContent = 'You\'re all set, ' + userName + '! üéâ';
}

// ============================
// SCREEN 3: GOAL AREAS
// ============================
function toggleArea(card) {
    card.classList.toggle('selected');
    userGoalAreas = [];
    document.querySelectorAll('#goalAreaGrid .select-card.selected').forEach(function(c) {
        userGoalAreas.push(c.dataset.area);
    });
    document.getElementById('goalAreaBtn').disabled = userGoalAreas.length === 0;
}

// ============================
// SCREEN 4: EXPERIENCE
// ============================
function selectExp(card) {
    document.querySelectorAll('#expGrid .select-card').forEach(function(c) { c.classList.remove('selected'); });
    card.classList.add('selected');
    userExperience = card.dataset.exp;
    document.getElementById('expBtn').disabled = false;

    // Dynamic ninja response
    var resp = document.getElementById('expResponse');
    var ninja = document.getElementById('expNinja');
    if (userExperience === 'new') {
        resp.textContent = "We'll make this easy for you! üôå";
        ninja.src = '../ninja-poses/ninja-wealth.png';
    } else if (userExperience === 'tried') {
        resp.textContent = 'This time will be different! üí™';
        ninja.src = '../ninja-poses/ninja-thumbsup.png';
    } else {
        resp.textContent = "Let's level up together! ‚öîÔ∏è";
        ninja.src = '../ninja-poses/ninja-action.png';
    }
    resp.classList.add('visible');
}

// ============================
// SCREEN 5: PAIN POINTS
// ============================
function togglePain(card) {
    card.classList.toggle('selected');
    userPainPoints = [];
    document.querySelectorAll('#painGrid .select-card.selected').forEach(function(c) {
        userPainPoints.push(c.dataset.pain);
    });
    document.getElementById('painBtn').disabled = userPainPoints.length === 0;
}

// ============================
// SCREEN 7: PLAN ANIMATION
// ============================
function triggerPlanAnimation() {
    var calcWrap = document.getElementById('calcWrap');
    var planResult = document.getElementById('planResult');
    calcWrap.classList.remove('hidden');
    planResult.style.display = 'none';

    setTimeout(function() {
        calcWrap.classList.add('hidden');
        planResult.style.display = 'flex';
        buildPlanCard();
    }, 2500);
}

function buildPlanCard() {
    var primary = userGoalAreas[0] || 'fitness';
    var template = goalTemplates[primary];
    selectedIcon = template.icon;
    
    var totalPenalty = 0;
    template.habits.forEach(function(h) { totalPenalty += h.penalty; });

    var html = '<div class="plan-header">';
    html += '<div class="plan-icon">' + template.emoji + '</div>';
    html += '<div class="plan-name">' + template.name + '</div>';
    html += '</div>';
    html += '<div class="plan-detail"><span class="plan-label">Duration</span><span class="plan-value">30 days</span></div>';
    html += '<div class="plan-detail"><span class="plan-label">Target</span><span class="plan-value">80%</span></div>';
    html += '<div class="plan-detail"><span class="plan-label">Daily stakes</span><span class="plan-value">$' + totalPenalty + '/day</span></div>';
    html += '<div class="plan-habits-list">';
    template.habits.forEach(function(h) {
        html += '<div class="plan-habit-item"><span class="plan-habit-name">' + h.name + '</span><span class="plan-habit-penalty">$' + h.penalty + '</span></div>';
    });
    html += '</div>';

    if (userGoalAreas.length > 1) {
        var others = userGoalAreas.slice(1).map(function(a) { return goalTemplates[a] ? goalTemplates[a].name : a; }).join(', ');
        html += '<p style="font-size:12px; color:var(--text-secondary); margin-top:12px; text-align:center;">You can add goals for ' + others + ' anytime.</p>';
    }

    document.getElementById('planCard').innerHTML = html;
    
    // Pre-fill customize screen
    prefillCustomize(primary);
}

// ============================
// SCREEN 8: CUSTOMIZE
// ============================
function prefillCustomize(area) {
    var template = goalTemplates[area];
    document.getElementById('customGoalName').value = template.name;
    selectedIcon = template.icon;

    // Build icon grid
    var iconHtml = '';
    iconIds.forEach(function(id) {
        var sel = id === selectedIcon ? ' selected' : '';
        iconHtml += '<div class="icon-option' + sel + '" data-icon="' + id + '" onclick="selectIcon(this)">';
        iconHtml += GN_getIconSVG(id, 20);
        iconHtml += '</div>';
    });
    document.getElementById('iconGrid').innerHTML = iconHtml;

    // Build habits list
    var habitsHtml = '';
    template.habits.forEach(function(h, i) {
        habitsHtml += buildHabitEditRow(h.name, h.penalty, h.icon, i, h.frequency || 'daily');
    });
    document.getElementById('habitsEditList').innerHTML = habitsHtml;
}

// ---- Frequency helpers ----
function parseFrequencyOnboarding(freq) {
    if (!freq || freq === 'daily') return { num: 1, unit: 'days' };
    if (freq === 'weekly') return { num: 1, unit: 'weeks' };
    if (freq === 'monthly') return { num: 1, unit: 'months' };
    var m = (freq || '').match(/^every(\d+)(days|weeks|months)$/);
    if (m) return { num: parseInt(m[1]), unit: m[2] };
    return { num: 1, unit: 'days' };
}

function buildFrequencyStringOnboarding(num, unit) {
    num = parseInt(num) || 1;
    if (num === 1 && unit === 'days') return 'daily';
    if (num === 1 && unit === 'weeks') return 'weekly';
    if (num === 1 && unit === 'months') return 'monthly';
    return 'every' + num + unit;
}

// ---- Habit Icon Picker ----
var habitIconList = [
    {id: 'target', label: 'Target'}, {id: 'exercise', label: 'Exercise'},
    {id: 'book', label: 'Reading'}, {id: 'meditation', label: 'Meditate'},
    {id: 'money', label: 'Finance'}, {id: 'coffee', label: 'Coffee'},
    {id: 'sleep', label: 'Sleep'}, {id: 'water', label: 'Water'},
    {id: 'food', label: 'Food'}, {id: 'sun', label: 'Wellness'},
    {id: 'phone', label: 'Screen'}, {id: 'shopping', label: 'Shopping'}
];

function openHabitIconPicker(iconDiv) {
    activeHabitIconTarget = iconDiv;
    var currentIcon = iconDiv.dataset.icon || 'target';
    var grid = document.getElementById('habitIconPickerGrid');
    var html = '';
    habitIconList.forEach(function(icon) {
        var sel = icon.id === currentIcon ? ' selected' : '';
        html += '<div class="habit-icon-pick-item' + sel + '" onclick="selectHabitIcon(\'' + icon.id + '\')">' +
            '<div class="habit-icon-pick-circle">' + GN_getIconSVG(icon.id, 22) + '</div>' +
            '<span class="habit-icon-pick-label">' + icon.label + '</span>' +
            '</div>';
    });
    grid.innerHTML = html;
    document.getElementById('habitIconPickerOverlay').classList.add('active');
}

function selectHabitIcon(iconId) {
    if (activeHabitIconTarget) {
        activeHabitIconTarget.dataset.icon = iconId;
        activeHabitIconTarget.innerHTML = GN_getIconSVG(iconId, 16);
        var editItem = activeHabitIconTarget.closest('.habit-edit-item');
        if (editItem) {
            var nameInput = editItem.querySelector('.habit-edit-name');
            if (nameInput) nameInput.dataset.icon = iconId;
        }
    }
    closeHabitIconPicker();
}

function closeHabitIconPicker(e) {
    if (e && e.target !== document.getElementById('habitIconPickerOverlay')) return;
    document.getElementById('habitIconPickerOverlay').classList.remove('active');
    activeHabitIconTarget = null;
}

// ---- Reminder & Start Date ----
function onOnbReminderChange(val) {
    if (!val) return;
    selectedReminder = val;
    var parts = val.split(':');
    var h = parseInt(parts[0]);
    var m = parts[1];
    var ampm = h >= 12 ? 'PM' : 'AM';
    var h12 = h % 12 || 12;
    document.getElementById('onbReminderDisplay').textContent = h12 + ':' + m + ' ' + ampm;
}

function onOnbStartDateChange(val) {
    if (!val) return;
    selectedStartDate = val;
    var today = GN_getTodayDateStr();
    if (val === today) {
        document.getElementById('onbStartDateDisplay').textContent = 'Today';
    } else {
        var d = new Date(val + 'T12:00:00');
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        document.getElementById('onbStartDateDisplay').textContent = months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }
}

// ---- Habit Row Builder ----
function buildHabitEditRow(name, penalty, icon, idx, frequency) {
    var parsed = parseFrequencyOnboarding(frequency || 'daily');
    return '<div class="habit-edit-item" data-idx="' + idx + '">' +
        '<div class="habit-edit-row">' +
        '<div class="habit-edit-icon" data-icon="' + icon + '" onclick="openHabitIconPicker(this)">' + GN_getIconSVG(icon, 16) + '</div>' +
        '<input type="text" class="habit-edit-name" value="' + name + '" placeholder="Habit name" data-icon="' + icon + '">' +
        '<input type="number" class="habit-edit-penalty" value="' + penalty + '" min="1" max="100" step="1">' +
        '<button class="habit-remove-btn" onclick="removeHabitRow(this)" title="Remove">\u2715</button>' +
        '</div>' +
        '<div class="habit-freq-row">' +
        '<span class="freq-label">Every</span>' +
        '<input type="number" class="habit-freq-num" value="' + parsed.num + '" min="1" max="365">' +
        '<select class="habit-freq-unit">' +
        '<option value="days"' + (parsed.unit === 'days' ? ' selected' : '') + '>day(s)</option>' +
        '<option value="weeks"' + (parsed.unit === 'weeks' ? ' selected' : '') + '>week(s)</option>' +
        '<option value="months"' + (parsed.unit === 'months' ? ' selected' : '') + '>month(s)</option>' +
        '</select>' +
        '</div>' +
        '</div>';
}

function addHabitRow() {
    var list = document.getElementById('habitsEditList');
    var idx = list.children.length;
    var html = buildHabitEditRow('', 5, 'target', idx, 'daily');
    list.insertAdjacentHTML('beforeend', html);
}

function removeHabitRow(btn) {
    var item = btn.closest('.habit-edit-item');
    if (document.getElementById('habitsEditList').children.length > 1) {
        item.remove();
    }
}

function selectIcon(el) {
    document.querySelectorAll('#iconGrid .icon-option').forEach(function(o) { o.classList.remove('selected'); });
    el.classList.add('selected');
    selectedIcon = el.dataset.icon;
}

function selectDuration(el) {
    document.querySelectorAll('#durationRow .pill').forEach(function(p) { p.classList.remove('selected'); });
    el.classList.add('selected');
    selectedDuration = parseInt(el.dataset.dur);
}

function updateTargetLabel() {
    document.getElementById('targetValue').textContent = document.getElementById('targetSlider').value + '%';
}

function createGoalAndContinue() {
    var goalName = document.getElementById('customGoalName').value.trim() || 'My Goal';
    var goalDesc = document.getElementById('customGoalDesc') ? document.getElementById('customGoalDesc').value.trim() : '';
    var target = parseInt(document.getElementById('targetSlider').value) || 80;

    // Validate at least one habit
    var habitItems = document.querySelectorAll('#habitsEditList .habit-edit-item');
    var validHabits = [];
    habitItems.forEach(function(item) {
        var hName = item.querySelector('.habit-edit-name').value.trim();
        if (hName) validHabits.push(item);
    });
    if (validHabits.length === 0) {
        alert('Please add at least one habit');
        return;
    }

    // Create goal
    var goalData = {
        name: goalName,
        icon: selectedIcon,
        description: goalDesc,
        duration: selectedDuration,
        target: target
    };
    if (selectedStartDate) goalData.startDate = selectedStartDate;

    var goal = GN_addGoal(goalData);
    createdGoalId = goal.id;
    createdHabitIds = [];

    // Create habits
    validHabits.forEach(function(item) {
        var nameInput = item.querySelector('.habit-edit-name');
        var penaltyInput = item.querySelector('.habit-edit-penalty');
        var freqNum = item.querySelector('.habit-freq-num');
        var freqUnit = item.querySelector('.habit-freq-unit');
        var hName = nameInput.value.trim();
        var hPenalty = parseFloat(penaltyInput.value) || 5;
        var hIcon = nameInput.dataset.icon || 'target';
        var freq = 'daily';
        if (freqNum && freqUnit) {
            freq = buildFrequencyStringOnboarding(parseInt(freqNum.value) || 1, freqUnit.value);
        }

        var habit = GN_addHabit({
            name: hName,
            icon: hIcon,
            penalty: hPenalty,
            frequency: freq,
            reminder: selectedReminder,
            goalIds: [goal.id]
        });
        createdHabitIds.push(habit.id);
    });

    goNext();
}

// ============================
// SCREEN 9: COMMITMENT
// ============================
function toggleCommit(item) {
    item.classList.toggle('checked');
}

// ============================
// SCREEN 10: PRO
// ============================
function proInterest(interested) {
    localStorage.setItem('goalNinjaProInterest', interested ? 'true' : 'false');
}

// ============================
// SCREEN 11: SUCCESS
// ============================
function triggerSuccess() {
    // Build summary card
    var goalName = document.getElementById('customGoalName').value.trim() || 'My Goal';
    var template = goalTemplates[userGoalAreas[0] || 'fitness'];
    var totalPenalty = 0;
    var habitItems = document.querySelectorAll('#habitsEditList .habit-edit-item');
    habitItems.forEach(function(item) {
        var p = parseFloat(item.querySelector('.habit-edit-penalty').value) || 0;
        totalPenalty += p;
    });

    var html = '<div class="summary-icon">' + template.emoji + '</div>';
    html += '<div class="summary-goal-name">' + goalName + '</div>';
    html += '<div class="summary-stats">';
    html += '<div class="summary-stat"><div class="summary-stat-value">' + createdHabitIds.length + '</div><div class="summary-stat-label">Habits</div></div>';
    html += '<div class="summary-stat"><div class="summary-stat-value">' + selectedDuration + 'd</div><div class="summary-stat-label">Duration</div></div>';
    html += '<div class="summary-stat"><div class="summary-stat-value">$' + totalPenalty + '</div><div class="summary-stat-label">Daily Stakes</div></div>';
    html += '</div>';
    document.getElementById('summaryCard').innerHTML = html;

    // Build quick-win habits for screen 12
    buildQuickWin();

    // Fire confetti
    launchConfetti();
}

// ============================
// CONFETTI
// ============================
function launchConfetti() {
    var container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);
    var colors = ['#E67E22', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
    for (var i = 0; i < 60; i++) {
        var piece = document.createElement('div');
        piece.className = 'confetti';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        piece.style.animationDelay = Math.random() * 2 + 's';
        piece.style.animationDuration = (2 + Math.random() * 2) + 's';
        piece.style.width = (6 + Math.random() * 8) + 'px';
        piece.style.height = (8 + Math.random() * 10) + 'px';
        container.appendChild(piece);
    }
    setTimeout(function() { container.remove(); }, 5000);
}

// ============================
// SCREEN 12: QUICK WIN
// ============================
function buildQuickWin() {
    var habits = GN_getHabits();
    var html = '';
    createdHabitIds.forEach(function(hid) {
        var habit = habits.find(function(h) { return h.id === hid; });
        if (!habit) return;
        html += '<div class="qw-habit" id="qw-' + hid + '">';
        html += '<div class="qw-habit-info">';
        html += '<span style="display:flex;align-items:center;">' + GN_getIconSVG(habit.icon, 20) + '</span>';
        html += '<span class="qw-habit-name">' + habit.name + '</span>';
        html += '</div>';
        html += '<button class="qw-check-btn" onclick="quickCheckin(\'' + hid + '\', this)">';
        html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>';
        html += '</button>';
        html += '</div>';
    });
    document.getElementById('qwHabitsList').innerHTML = html;
}

function quickCheckin(habitId, btn) {
    var row = document.getElementById('qw-' + habitId);
    if (row.classList.contains('done')) return;
    
    GN_recordHabitCheckin(habitId, GN_getTodayDateStr(), 'completed');
    row.classList.add('done');

    // Ninja reaction
    var ninja = document.getElementById('qwNinja');
    ninja.src = '../ninja-poses/ninja-thumbsup.png';
    var sub = document.getElementById('qwSubtitle');
    sub.textContent = "That's the way, " + userName + "! üî•";
}

// ============================
// FINISH
// ============================
function finishOnboarding() {
    localStorage.setItem('goalNinjaOnboarded', 'true');
    window.location.href = './goal-effect-home.html';
}

// ============================
// INIT
// ============================
(function init() {
    // If already onboarded, redirect
    if (localStorage.getItem('goalNinjaOnboarded') === 'true') {
        window.location.href = './goal-effect-home.html';
        return;
    }

    // Check for existing name
    var existing = localStorage.getItem('goalNinjaUserName');
    if (existing) {
        userName = existing;
        document.getElementById('nameInput').value = existing;
    }

    // Init start date picker
    var startInput = document.getElementById('onbStartDateInput');
    if (startInput) {
        var today = GN_getTodayDateStr();
        startInput.min = today;
        startInput.value = today;
        selectedStartDate = today;
    }

    goTo(0);
})();
</script>
</body>
</html>