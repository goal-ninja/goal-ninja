<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="light only">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../icons/apple-touch-icon.png?v=2">
    <title>Goal Ninja - Analytics</title>
    <style>
        :root {
            color-scheme: light;
            forced-color-adjust: none;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6b6b6b;
            --text-muted: #999999;
            --accent: #E67E22;
            --border: #e5e5e5;
            --success: #22c55e;
            --success-light: #dcfce7;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .phone-frame {
            width: 100%;
            height: 100vh;
            margin: 0 auto;
            background: var(--bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 500px) {
            body {
                background: #1a1a1a;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 20px;
            }
            .phone-frame {
                max-width: 390px;
                max-height: 844px;
                border-radius: 40px;
                box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            }
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 100px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 12px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            padding: 0;
            font-family: inherit;
        }
        .back-btn svg { width: 20px; height: 20px; }
        .page-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .profile-btn {
            width: 44px;
            height: 44px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .profile-btn svg { width: 22px; height: 22px; color: var(--text-secondary); }

        /* Dark Stats Banner */
        .stats-banner {
            background: var(--text-primary);
            color: white;
            border-radius: 20px;
            padding: 24px 16px 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .stats-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        .stats-banner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .stats-banner-item { text-align: center; }
        .stats-banner-value {
            font-size: 28px;
            font-weight: 700;
        }
        .stats-banner-value.green { color: #22c55e; }
        .stats-banner-value.orange { color: #E67E22; }
        .stats-banner-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #ffffff;
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .tab {
            flex: 1;
            background: none;
            border: none;
            border-radius: 11px;
            padding: 10px 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .tab.active {
            background: var(--text-primary);
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Section */
        .section {
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        /* Cards */
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
        }

        /* Consistency Score */
        .score-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .score-ring-container {
            position: relative;
            width: 100px;
            height: 100px;
            flex-shrink: 0;
        }
        .score-ring-container svg { transform: rotate(-90deg); }
        .score-ring-bg { fill: none; stroke: #f0f0f0; stroke-width: 7; }
        .score-ring-fill {
            fill: none;
            stroke-width: 7;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s ease;
        }
        .score-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .score-ring-number {
            font-size: 28px;
            font-weight: 700;
            display: block;
            line-height: 1;
        }
        .score-ring-label {
            font-size: 10px;
            color: var(--text-muted);
        }
        .score-info { flex: 1; }
        .score-info-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .score-info-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .score-trend {
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 8px;
        }
        .score-trend.up { background: var(--success-light); color: #16a34a; }
        .score-trend.down { background: #fef2f2; color: #dc2626; }
        .score-trend.neutral { background: #f5f5f5; color: var(--text-muted); }

        /* Heatmap */
        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .heatmap-title {
            font-size: 15px;
            font-weight: 600;
        }
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .heatmap-legend-cell {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        .heatmap-wrapper {
            display: flex;
            gap: 4px;
        }
        .heatmap-days {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding-top: 0;
        }
        .heatmap-day-label {
            height: 14px;
            font-size: 9px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 14px);
            grid-auto-flow: column;
            gap: 2px;
            flex: 1;
            overflow-x: auto;
        }
        .heatmap-cell {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.15s;
        }
        .heatmap-cell:hover {
            outline: 2px solid var(--accent);
            outline-offset: 1px;
        }
        .heatmap-cell.level-1 { background: #dcfce7; }
        .heatmap-cell.level-2 { background: #86efac; }
        .heatmap-cell.level-3 { background: #4ade80; }
        .heatmap-cell.level-4 { background: #22c55e; }
        .heatmap-cell.has-missed { background: #fecaca; }
        .heatmap-tooltip {
            display: none;
            position: fixed;
            background: var(--text-primary);
            color: white;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 200;
            white-space: nowrap;
        }

        /* Sparkline */
        .sparkline-card {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .sparkline-info { flex: 1; }
        .sparkline-info-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .sparkline-info-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Habit Bars (Chart.js) */

        /* Streak List */
        .streak-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .streak-item:last-child { border-bottom: none; }
        .streak-left { display: flex; align-items: center; gap: 10px; }
        .streak-rank {
            width: 24px;
            height: 24px;
            background: var(--bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
        }
        .streak-name { font-size: 14px; font-weight: 500; }
        .streak-right { text-align: right; }
        .streak-current {
            font-size: 15px;
            font-weight: 700;
        }
        .streak-best {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Goal Progress Cards */
        .goal-progress-item {
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }
        .goal-progress-item:last-child { border-bottom: none; }
        .goal-progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .goal-progress-icon {
            width: 36px;
            height: 36px;
            background: var(--bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .goal-progress-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
        .goal-progress-info { flex: 1; }
        .goal-progress-name { font-size: 14px; font-weight: 600; }
        .goal-progress-meta { font-size: 11px; color: var(--text-muted); }
        .goal-progress-rate {
            font-size: 16px;
            font-weight: 700;
        }
        .goal-progress-track {
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
        }
        .goal-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Category Bar Chart (Chart.js) */

        /* Success Pattern Charts */
        .sp-chart-card { padding: 14px; }
        .sp-chart-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .sp-chart-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        /* Chart.js Containers */
        .chart-container { position: relative; width: 100%; }
        .chart-container--bar { height: 100px; }
        .chart-container--line { height: 120px; }
        .chart-container--sparkline { width: 120px; height: 48px; flex-shrink: 0; }
        .chart-container--horizontal-bar { min-height: 60px; }

        /* Pro Lock Overlay */
        .pro-section { position: relative; }
        .pro-section .pro-content {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }
        .pro-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .pro-badge {
            background: linear-gradient(135deg, #E67E22, #f39c12);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        .pro-lock-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        .pro-unlock-btn {
            background: var(--text-primary);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .empty-state-desc { font-size: 13px; line-height: 1.4; }

        /* Animations */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeUp 0.4s ease-out both; }
        .delay-1 { animation-delay: 0.05s; }
        .delay-2 { animation-delay: 0.1s; }
        .delay-3 { animation-delay: 0.15s; }
        .delay-4 { animation-delay: 0.2s; }
        .delay-5 { animation-delay: 0.25s; }

        /* Add Button */
        .add-btn {
            width: 44px;
            height: 44px;
            background: var(--text-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }
        .add-btn svg { width: 22px; height: 22px; color: white; }

        /* Bottom Navigation */
        .bottom-nav {
            position: absolute;
            bottom: 18px;
            left: 16px;
            right: 16px;
            background: var(--card-bg);
            border-radius: 28px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 8px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.04);
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 8px 16px;
            background: none;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            color: var(--text-muted);
            font-family: inherit;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item.active {
            color: var(--text-primary);
            background: rgba(0, 0, 0, 0.06);
        }
        .nav-item svg { width: 22px; height: 22px; }
        .nav-item span { font-size: 10px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="main-content">

            <!-- Header -->
            <div class="header animate-in">
                <div class="header-left">
                    <button class="back-btn" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>
                <div class="header-actions">
                    <button class="add-btn" onclick="window.location.href='goal-effect-templates.html'" title="New Goal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                    <button class="profile-btn" onclick="window.location.href='goal-effect-leaderboard.html'" title="Leaderboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                    </button>
                </div>
            </div>

            <h1 class="page-title animate-in" style="margin-bottom:20px;">Analytics</h1>

            <!-- Dark Stats Banner -->
            <div class="stats-banner animate-in delay-1">
                <div class="stats-banner-grid">
                    <div class="stats-banner-item">
                        <div class="stats-banner-value green" id="bannerRate">0%</div>
                        <div class="stats-banner-label">Completion Rate</div>
                    </div>
                    <div class="stats-banner-item">
                        <div class="stats-banner-value orange" id="bannerStreak">0</div>
                        <div class="stats-banner-label">Best Streak</div>
                    </div>
                    <div class="stats-banner-item">
                        <div class="stats-banner-value" id="bannerScore" style="color:#E67E22">0</div>
                        <div class="stats-banner-label">Consistency Score</div>
                    </div>
                    <div class="stats-banner-item">
                        <div class="stats-banner-value" id="bannerSavings">$0</div>
                        <div class="stats-banner-label">Total Savings</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs animate-in delay-2">
                <button class="tab active" onclick="switchTab('overview')">Overview</button>
                <button class="tab" onclick="switchTab('habits')">Habits</button>
                <button class="tab" onclick="switchTab('goals')">Goals</button>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div class="tab-content active" id="tab-overview">

                <!-- Consistency Score -->
                <div class="section animate-in delay-3">
                    <div class="card">
                        <div class="score-card">
                            <div class="score-ring-container">
                                <svg width="100" height="100" viewBox="0 0 100 100">
                                    <circle class="score-ring-bg" cx="50" cy="50" r="42"/>
                                    <circle class="score-ring-fill" id="scoreRingFill" cx="50" cy="50" r="42" stroke-dasharray="0 263.9" stroke="#22c55e"/>
                                </svg>
                                <div class="score-ring-text">
                                    <span class="score-ring-number" id="scoreNumber">0</span>
                                    <span class="score-ring-label">/100</span>
                                </div>
                            </div>
                            <div class="score-info">
                                <div class="score-info-title">Consistency Score</div>
                                <div class="score-info-desc">Based on completion rate, streak length, and daily regularity.</div>
                                <span class="score-trend neutral" id="scoreTrend">â€” No change</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Heatmap -->
                <div class="section animate-in delay-3">
                    <div class="card">
                        <div class="heatmap-header">
                            <span class="heatmap-title">Activity</span>
                            <div class="heatmap-legend">
                                <span>Less</span>
                                <div class="heatmap-legend-cell" style="background:#f0f0f0"></div>
                                <div class="heatmap-legend-cell" style="background:#dcfce7"></div>
                                <div class="heatmap-legend-cell" style="background:#86efac"></div>
                                <div class="heatmap-legend-cell" style="background:#4ade80"></div>
                                <div class="heatmap-legend-cell" style="background:#22c55e"></div>
                                <span>More</span>
                            </div>
                        </div>
                        <div class="heatmap-wrapper">
                            <div class="heatmap-days">
                                <div class="heatmap-day-label">M</div>
                                <div class="heatmap-day-label">T</div>
                                <div class="heatmap-day-label">W</div>
                                <div class="heatmap-day-label">T</div>
                                <div class="heatmap-day-label">F</div>
                                <div class="heatmap-day-label">S</div>
                                <div class="heatmap-day-label">S</div>
                            </div>
                            <div class="heatmap-grid" id="heatmapGrid"></div>
                        </div>
                    </div>
                    <div class="heatmap-tooltip" id="heatmapTooltip"></div>
                </div>

                <!-- Weekly Trend -->
                <div class="section animate-in delay-4">
                    <div class="card">
                        <div class="sparkline-card">
                            <div class="sparkline-info">
                                <div class="sparkline-info-title">Weekly Trend</div>
                                <div class="sparkline-info-desc" id="sparklineDesc">Loading...</div>
                            </div>
                            <div class="chart-container chart-container--sparkline">
                                <canvas id="chartSparkline"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Patterns -->
                <div class="section animate-in delay-4">
                    <h3 class="section-title">Success Patterns</h3>

                    <!-- Best Day Bar Chart -->
                    <div class="card sp-chart-card">
                        <div class="sp-chart-title">Best Day to Complete Habits</div>
                        <div class="sp-chart-subtitle" id="spBestDayLabel">â€”</div>
                        <div class="chart-container chart-container--bar">
                            <canvas id="chartBestDay"></canvas>
                        </div>
                    </div>

                    <!-- Penalty Impact Line Chart -->
                    <div class="card sp-chart-card" style="margin-top:10px">
                        <div class="sp-chart-title">Penalty vs Completion Rate</div>
                        <div class="sp-chart-subtitle" id="spPenaltyLabel">â€”</div>
                        <div class="chart-container chart-container--line">
                            <canvas id="chartPenalty"></canvas>
                        </div>
                    </div>

                    <!-- Goal Complexity Line Chart -->
                    <div class="card sp-chart-card" style="margin-top:10px">
                        <div class="sp-chart-title">Goal Complexity vs Completion Rate</div>
                        <div class="sp-chart-subtitle" id="spComplexityLabel">â€”</div>
                        <div class="chart-container chart-container--line">
                            <canvas id="chartComplexity"></canvas>
                        </div>
                    </div>

                    <!-- Goal Timeframe Line Chart -->
                    <div class="card sp-chart-card" style="margin-top:10px">
                        <div class="sp-chart-title">Goal Duration vs Completion Rate</div>
                        <div class="sp-chart-subtitle" id="spTimeframeLabel">â€”</div>
                        <div class="chart-container chart-container--line">
                            <canvas id="chartTimeframe"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Community Benchmarks (PRO) -->
                <div class="section animate-in delay-5">
                    <h3 class="section-title">Community Benchmarks</h3>
                    <div class="card">
                        <div class="pro-content" id="benchmarksContent">
                            <div style="display:flex;justify-content:space-around;text-align:center;margin-bottom:14px">
                                <div>
                                    <div style="font-size:22px;font-weight:700;color:#22c55e" id="benchmarkYou">â€”</div>
                                    <div style="font-size:11px;color:var(--text-muted)">You</div>
                                </div>
                                <div style="width:1px;background:var(--border)"></div>
                                <div>
                                    <div style="font-size:22px;font-weight:700;color:var(--text-muted)" id="benchmarkCommunity">71%</div>
                                    <div style="font-size:11px;color:var(--text-muted)">Community Avg</div>
                                </div>
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);text-align:center;margin-bottom:10px" id="benchmarkRank">â€”</div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center" id="benchmarkTags"></div>
                            <div style="font-size:9px;color:var(--text-muted);text-align:center;margin-top:8px">Based on community averages</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- TAB 2: HABITS -->
            <div class="tab-content" id="tab-habits">

                <!-- Habit Completion Rates -->
                <div class="section animate-in delay-3">
                    <h3 class="section-title">Completion Rates</h3>
                    <div class="card" id="habitBarsContainer">
                        <div class="chart-container chart-container--horizontal-bar" id="habitBarsChartWrap">
                            <canvas id="chartHabitBars"></canvas>
                        </div>
                        <div class="empty-state" id="habitBarsEmpty" style="display:none">
                            <div class="empty-state-icon">ðŸ“Š</div>
                            <div class="empty-state-title">No habits yet</div>
                            <div class="empty-state-desc">Create some goals and habits to see your analytics.</div>
                        </div>
                    </div>
                </div>

                <!-- Streak Leaderboard -->
                <div class="section animate-in delay-3">
                    <h3 class="section-title">Streak Leaderboard</h3>
                    <div class="card" id="streakContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ”¥</div>
                            <div class="empty-state-title">No streaks yet</div>
                            <div class="empty-state-desc">Start checking in daily to build your streaks.</div>
                        </div>
                    </div>
                </div>

                <!-- Habit Drop-off (PRO) -->
                <div class="section animate-in delay-4">
                    <h3 class="section-title">Drop-off Analysis</h3>
                    <div class="card">
                        <div class="pro-content" id="dropoffContent">
                            <div style="font-size:13px;font-weight:600;margin-bottom:10px">Where habits lose momentum</div>
                            <div class="chart-container chart-container--bar">
                                <canvas id="chartDropoff"></canvas>
                            </div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:10px;padding:8px;background:#fef2f2;border-radius:8px;text-align:center" id="dropoffInsight"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: GOALS -->
            <div class="tab-content" id="tab-goals">

                <!-- Goal Progress -->
                <div class="section animate-in delay-3">
                    <h3 class="section-title">Goal Progress</h3>
                    <div class="card" id="goalProgressContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŽ¯</div>
                            <div class="empty-state-title">No goals yet</div>
                            <div class="empty-state-desc">Create a goal to start tracking your progress.</div>
                        </div>
                    </div>
                </div>

                <!-- Category Performance -->
                <div class="section animate-in delay-3">
                    <h3 class="section-title">By Category</h3>
                    <div class="card" id="categoryContainer">
                        <div class="chart-container chart-container--horizontal-bar" id="categoryChartWrap">
                            <canvas id="chartCategories"></canvas>
                        </div>
                        <div class="empty-state" id="categoryEmpty" style="display:none">
                            <div class="empty-state-icon">ðŸ“‚</div>
                            <div class="empty-state-title">No data yet</div>
                            <div class="empty-state-desc">Create goals to see category breakdown.</div>
                        </div>
                    </div>
                </div>

                <!-- Timeframe Analysis (PRO) -->
                <div class="section animate-in delay-4">
                    <h3 class="section-title">Timeframe Analysis</h3>
                    <div class="card">
                        <div class="pro-content" id="timeframeContent">
                            <div class="chart-container chart-container--bar" style="height:120px">
                                <canvas id="chartTimeframeAnalysis"></canvas>
                            </div>
                            <div style="font-size:11px;color:var(--text-secondary);text-align:center;margin-top:8px" id="timeframeInsight"></div>
                        </div>
                    </div>
                </div>

                <!-- Goal Drop-off Points (PRO) -->
                <div class="section animate-in delay-5">
                    <h3 class="section-title">Goal Drop-off Points</h3>
                    <div class="card">
                        <div class="pro-content" id="goalDropoffContent">
                            <div style="font-size:13px;font-weight:600;margin-bottom:12px">Where goals typically fail</div>
                            <div class="chart-container chart-container--bar">
                                <canvas id="chartGoalDropoff"></canvas>
                            </div>
                            <div style="font-size:11px;color:var(--text-secondary);padding:8px;background:#fef2f2;border-radius:8px;text-align:center;margin-top:10px" id="goalDropoffInsight"></div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item" onclick="goTo('home')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>Home</span>
            </button>
            <button class="nav-item" onclick="goTo('goals')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
                </svg>
                <span>Goals</span>
            </button>
            <button class="nav-item" onclick="goTo('habits')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                </svg>
                <span>Habits</span>
            </button>
            <button class="nav-item" onclick="goTo('savings')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                <span>Savings</span>
            </button>
            <button class="nav-item" onclick="goTo('profile')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Profile</span>
            </button>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="goal-ninja-data.js"></script>
    <script src="ninja-buddy.js"></script>
    <script>
        // ---- CHART.JS SETUP ----
        var chartInstances = {};

        function destroyChart(key) {
            if (chartInstances[key]) {
                chartInstances[key].destroy();
                delete chartInstances[key];
            }
        }

        function isDarkMode() {
            return document.documentElement.getAttribute('data-theme') === 'dark';
        }

        function chartColors() {
            var dark = isDarkMode();
            return {
                gridColor: dark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',
                tickColor: dark ? '#aaa' : '#999',
                tooltipBg: dark ? '#333' : '#1a1a1a',
                tooltipText: dark ? '#f0f0f0' : '#fff',
                avgLineColor: dark ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.18)',
                avgLabelColor: dark ? '#888' : '#999',
                emptyBarBg: dark ? '#2a2a2a' : '#f0f0f0',
                emptyBarBorder: dark ? '#444' : 'rgba(0,0,0,0.06)'
            };
        }

        // Custom plugin for community average dashed line
        var communityAvgPlugin = {
            id: 'communityAvgLine',
            afterDraw: function(chart) {
                var meta = chart.options.plugins.communityAvgLine;
                if (!meta || meta.value == null) return;
                var c = chartColors();
                var yScale = chart.scales.y;
                if (!yScale) return;
                var yPixel = yScale.getPixelForValue(meta.value);
                var ctx = chart.ctx;
                ctx.save();
                ctx.beginPath();
                ctx.setLineDash([6, 4]);
                ctx.strokeStyle = c.avgLineColor;
                ctx.lineWidth = 1.5;
                ctx.moveTo(chart.chartArea.left, yPixel);
                ctx.lineTo(chart.chartArea.right, yPixel);
                ctx.stroke();
                ctx.fillStyle = c.avgLabelColor;
                ctx.font = '600 9px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(meta.label || ('Avg ' + meta.value + '%'), chart.chartArea.right, yPixel - 4);
                ctx.restore();
            }
        };

        Chart.register(communityAvgPlugin);
        Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif";
        Chart.defaults.font.size = 11;
        Chart.defaults.animation.duration = 800;
        Chart.defaults.animation.easing = 'easeOutQuart';
        Chart.defaults.plugins.legend.display = false;
        Chart.defaults.plugins.tooltip.backgroundColor = '#1a1a1a';
        Chart.defaults.plugins.tooltip.titleFont = { size: 11, weight: '600' };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 11 };
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.padding = { top: 6, bottom: 6, left: 10, right: 10 };
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        // ---- ICON TO CATEGORY MAPPING ----
        var ICON_CATEGORIES = {
            exercise: 'Fitness', workout: 'Fitness', run: 'Fitness', fitness: 'Fitness',
            book: 'Learning', reading: 'Learning',
            meditation: 'Wellness', meditate: 'Wellness', sleep: 'Wellness', sun: 'Wellness',
            money: 'Finance', saving: 'Finance', shopping: 'Finance',
            phone: 'Productivity', social: 'Productivity', nosocial: 'Productivity',
            coffee: 'Lifestyle', nocoffee: 'Lifestyle', food: 'Lifestyle', water: 'Lifestyle',
            target: 'General'
        };

        function getCategoryForIcon(icon) {
            return ICON_CATEGORIES[icon] || ICON_CATEGORIES[(icon || '').toLowerCase()] || 'General';
        }

        // ---- NAVIGATION ----
        function goBack() { window.history.back(); }

        function goTo(page) {
            if (page === 'home') window.location.href = 'goal-effect-home.html';
            else if (page === 'goals') window.location.href = 'goal-effect-goals-list.html';
            else if (page === 'habits') window.location.href = 'goal-effect-habits-list.html';
            else if (page === 'savings') window.location.href = 'goal-effect-savings.html';
            else if (page === 'profile') window.location.href = 'goal-effect-profile.html';
        }

        // ---- TAB SWITCHING ----
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            event.target.classList.add('active');
            var el = document.getElementById('tab-' + tabName);
            if (el) el.classList.add('active');
            // Trigger Chart.js resize for newly-visible tab
            setTimeout(function() {
                for (var key in chartInstances) {
                    if (chartInstances[key]) chartInstances[key].resize();
                }
            }, 50);
        }

        function rebuildAllCharts() {
            buildSparkline();
            buildHabitBars();
            buildCategories();
            buildBestDayChart();
            buildPenaltyChart();
            buildComplexityChart();
            buildTimeframeChart();
            buildDropoff();
            buildTimeframe();
            buildGoalDropoff();
        }

        // ---- CONSISTENCY SCORE ----
        function calculateConsistencyScore() {
            var stats = GN_getOverallStats();
            var allCheckins = GN_getAllCheckins();
            var goals = GN_getGoals();

            // Completion weight (40%)
            var completionWeight = stats.overallCompletionRate || 0;

            // Streak weight (30%) â€” best active streak, capped at 20 days = 100
            var streakWeight = Math.min(100, (stats.bestStreak || 0) * 5);

            // Regularity weight (30%) â€” days with at least 1 checkin / total days since first goal
            var earliestDate = null;
            goals.forEach(function(g) {
                if (g.startDate && (!earliestDate || g.startDate < earliestDate)) earliestDate = g.startDate;
            });

            var regularityWeight = 0;
            if (earliestDate) {
                var today = GN_getTodayDateStr();
                var totalDays = Math.max(1, GN_daysBetween(earliestDate, today) + 1);
                var activeDays = {};
                for (var hid in allCheckins) {
                    for (var d in allCheckins[hid]) {
                        if (allCheckins[hid][d] === 'complete') activeDays[d] = true;
                    }
                }
                regularityWeight = Math.min(100, (Object.keys(activeDays).length / totalDays) * 100);
            }

            var score = Math.round((completionWeight * 0.4) + (streakWeight * 0.3) + (regularityWeight * 0.3));
            return Math.min(100, Math.max(0, score));
        }

        // ---- HEATMAP ----
        function buildHeatmap() {
            var grid = document.getElementById('heatmapGrid');
            var tooltip = document.getElementById('heatmapTooltip');
            var allCheckins = GN_getAllCheckins();
            var habits = GN_getHabits();
            var totalHabits = habits.length || 1;

            var today = new Date();
            // Go back 12 weeks (84 days) and align to Monday
            var start = new Date(today);
            start.setDate(start.getDate() - 83);
            // Align to Monday
            var dayOfWeek = start.getDay();
            var diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            start.setDate(start.getDate() + diff);

            var html = '';
            var current = new Date(start);
            while (current <= today) {
                var y = current.getFullYear();
                var m = String(current.getMonth() + 1).padStart(2, '0');
                var d = String(current.getDate()).padStart(2, '0');
                var dateStr = y + '-' + m + '-' + d;

                var completed = 0;
                var missed = 0;
                for (var hid in allCheckins) {
                    if (allCheckins[hid][dateStr] === 'complete') completed++;
                    if (allCheckins[hid][dateStr] === 'missed') missed++;
                }

                var pct = totalHabits > 0 ? completed / totalHabits : 0;
                var level = '';
                if (completed === 0 && missed > 0) level = 'has-missed';
                else if (pct > 0 && pct <= 0.25) level = 'level-1';
                else if (pct > 0.25 && pct <= 0.5) level = 'level-2';
                else if (pct > 0.5 && pct <= 0.75) level = 'level-3';
                else if (pct > 0.75) level = 'level-4';

                html += '<div class="heatmap-cell ' + level + '" data-date="' + dateStr + '" data-completed="' + completed + '" data-missed="' + missed + '"></div>';
                current.setDate(current.getDate() + 1);
            }
            grid.innerHTML = html;

            // Tooltip
            grid.addEventListener('click', function(e) {
                var cell = e.target.closest('.heatmap-cell');
                if (!cell) return;
                var date = cell.getAttribute('data-date');
                var comp = cell.getAttribute('data-completed');
                var miss = cell.getAttribute('data-missed');
                tooltip.textContent = date + ': ' + comp + ' done, ' + miss + ' missed';
                tooltip.style.display = 'block';
                var rect = cell.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - 30) + 'px';
                setTimeout(function() { tooltip.style.display = 'none'; }, 2000);
            });
        }

        // ---- SPARKLINE ----
        function buildSparkline() {
            var allCheckins = GN_getAllCheckins();
            var today = new Date();
            var weeks = [];

            for (var w = 7; w >= 0; w--) {
                var weekEnd = new Date(today);
                weekEnd.setDate(weekEnd.getDate() - (w * 7));
                var weekStart = new Date(weekEnd);
                weekStart.setDate(weekStart.getDate() - 6);

                var completed = 0;
                var total = 0;
                var cur = new Date(weekStart);
                while (cur <= weekEnd) {
                    var ds = cur.getFullYear() + '-' + String(cur.getMonth() + 1).padStart(2, '0') + '-' + String(cur.getDate()).padStart(2, '0');
                    for (var hid in allCheckins) {
                        if (allCheckins[hid][ds]) {
                            total++;
                            if (allCheckins[hid][ds] === 'complete') completed++;
                        }
                    }
                    cur.setDate(cur.getDate() + 1);
                }
                weeks.push(total > 0 ? Math.round((completed / total) * 100) : 0);
            }

            destroyChart('sparkline');
            var canvas = document.getElementById('chartSparkline');
            if (!canvas) return;

            var color = weeks[weeks.length - 1] >= weeks[weeks.length - 2] ? '#22c55e' : '#ef4444';
            var ctx = canvas.getContext('2d');
            var gradient = ctx.createLinearGradient(0, 0, 0, 48);
            gradient.addColorStop(0, color === '#22c55e' ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            chartInstances.sparkline = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: weeks.map(function(_, i) { return ''; }),
                    datasets: [{
                        data: weeks,
                        borderColor: color,
                        backgroundColor: gradient,
                        fill: true,
                        borderWidth: 2.5,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: color
                    }]
                },
                options: {
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: {
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                title: function() { return ''; },
                                label: function(ctx) { return ctx.parsed.y + '%'; }
                            }
                        }
                    },
                    animation: { duration: 600 },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            var desc = document.getElementById('sparklineDesc');
            var latest = weeks[weeks.length - 1];
            var prev = weeks[weeks.length - 2];
            var diff = latest - prev;
            if (diff > 0) desc.textContent = 'Completion rate is trending up â†‘' + diff + '% this week';
            else if (diff < 0) desc.textContent = 'Completion rate dropped â†“' + Math.abs(diff) + '% this week';
            else desc.textContent = 'Completion rate is steady this week';
        }

        // ---- HABIT BARS ----
        function buildHabitBars() {
            var habits = GN_getHabits();
            var chartWrap = document.getElementById('habitBarsChartWrap');
            var emptyEl = document.getElementById('habitBarsEmpty');
            if (!habits.length) {
                if (chartWrap) chartWrap.style.display = 'none';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            var items = [];
            habits.forEach(function(h) {
                var stats = GN_getHabitStats(h.id);
                if (!stats) return;
                items.push({ name: h.name, icon: h.icon || 'target', rate: stats.completionRate || 0 });
            });

            if (!items.length) {
                if (chartWrap) chartWrap.style.display = 'none';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            items.sort(function(a, b) { return b.rate - a.rate; });
            if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = Math.max(80, items.length * 32) + 'px'; }
            if (emptyEl) emptyEl.style.display = 'none';

            destroyChart('habitBars');
            var canvas = document.getElementById('chartHabitBars');
            if (!canvas) return;
            var c = chartColors();

            var bgColors = items.map(function(item) {
                return item.rate >= 80 ? '#22c55e' : item.rate >= 50 ? '#E67E22' : '#ef4444';
            });

            chartInstances.habitBars = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: items.map(function(item) { return item.name; }),
                    datasets: [{
                        data: items.map(function(item) { return item.rate; }),
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        borderSkipped: false,
                        barThickness: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true, max: 100,
                            ticks: { callback: function(v) { return v + '%'; }, color: c.tickColor, font: { size: 9 } },
                            grid: { color: c.gridColor },
                            border: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 11, weight: '500' }, crossAlign: 'far' },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: function(ctx) { return ctx.parsed.x + '% completion rate'; } }
                        }
                    }
                }
            });
        }

        // ---- STREAK LEADERBOARD ----
        function buildStreaks() {
            var habits = GN_getHabits();
            if (!habits.length) return;

            var items = [];
            habits.forEach(function(h) {
                var current = GN_getCurrentStreakForHabit(h.id);
                var best = GN_getBestStreakForHabit(h.id);
                items.push({ name: h.name, current: current || 0, best: best || 0 });
            });

            items.sort(function(a, b) { return b.current - a.current; });

            var html = '';
            items.forEach(function(item, i) {
                html += '<div class="streak-item">' +
                    '<div class="streak-left">' +
                    '<div class="streak-rank">' + (i + 1) + '</div>' +
                    '<div class="streak-name">' + item.name + '</div></div>' +
                    '<div class="streak-right">' +
                    '<div class="streak-current">' + (item.current > 0 ? 'ðŸ”¥ ' : '') + item.current + ' day' + (item.current !== 1 ? 's' : '') + '</div>' +
                    '<div class="streak-best">Best: ' + item.best + ' days</div></div></div>';
            });

            document.getElementById('streakContainer').innerHTML = html;
        }

        // ---- GOAL PROGRESS ----
        function buildGoalProgress() {
            var goals = GN_getActiveGoals();
            if (!goals.length) return;

            var html = '';
            goals.forEach(function(g) {
                var stats = GN_getGoalStats(g.id);
                if (!stats) return;

                var color = stats.completionRate >= g.target ? '#22c55e' : stats.completionRate >= (g.target * 0.7) ? '#E67E22' : '#ef4444';
                var status = stats.completionRate >= g.target ? 'On track' : stats.completionRate >= (g.target * 0.7) ? 'At risk' : 'Behind';
                var meta = g.duration > 0 ? 'Day ' + stats.dayNumber + ' of ' + g.duration : 'Ongoing';

                html += '<div class="goal-progress-item">' +
                    '<div class="goal-progress-header">' +
                    '<div class="goal-progress-icon">' + GN_getIconSVG(g.icon || 'target', 18) + '</div>' +
                    '<div class="goal-progress-info"><div class="goal-progress-name">' + g.name + '</div>' +
                    '<div class="goal-progress-meta">' + meta + ' Â· ' + status + '</div></div>' +
                    '<div class="goal-progress-rate" style="color:' + color + '">' + stats.completionRate + '%</div></div>' +
                    '<div class="goal-progress-track"><div class="goal-progress-fill" style="width:' + stats.progress + '%;background:' + color + '"></div></div></div>';
            });

            if (html) document.getElementById('goalProgressContainer').innerHTML = html;
        }

        // ---- CATEGORY PERFORMANCE ----
        function buildCategories() {
            var goals = GN_getGoals();
            var chartWrap = document.getElementById('categoryChartWrap');
            var emptyEl = document.getElementById('categoryEmpty');

            if (!goals.length) {
                if (chartWrap) chartWrap.style.display = 'none';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            var categories = {};
            goals.forEach(function(g) {
                if (g.status !== 'active' && g.status !== 'paused') return;
                var cat = getCategoryForIcon(g.icon || 'target');
                if (!categories[cat]) categories[cat] = { totalRate: 0, count: 0 };
                var stats = GN_getGoalStats(g.id);
                if (stats) {
                    categories[cat].totalRate += stats.completionRate;
                    categories[cat].count++;
                }
            });

            var items = [];
            for (var cat in categories) {
                if (categories[cat].count > 0) {
                    items.push({ name: cat, rate: Math.round(categories[cat].totalRate / categories[cat].count) });
                }
            }

            if (!items.length) {
                if (chartWrap) chartWrap.style.display = 'none';
                if (emptyEl) emptyEl.style.display = '';
                return;
            }

            items.sort(function(a, b) { return b.rate - a.rate; });
            if (chartWrap) { chartWrap.style.display = ''; chartWrap.style.height = Math.max(80, items.length * 32) + 'px'; }
            if (emptyEl) emptyEl.style.display = 'none';

            destroyChart('categories');
            var canvas = document.getElementById('chartCategories');
            if (!canvas) return;
            var c = chartColors();

            var colorMap = { Fitness: '#22c55e', Learning: '#3b82f6', Wellness: '#8b5cf6', Finance: '#E67E22', Productivity: isDarkMode() ? '#f0f0f0' : '#1a1a1a', Lifestyle: '#ec4899', General: '#6b7280' };
            var bgColors = items.map(function(item) { return colorMap[item.name] || '#6b7280'; });

            chartInstances.categories = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: items.map(function(item) { return item.name; }),
                    datasets: [{
                        data: items.map(function(item) { return item.rate; }),
                        backgroundColor: bgColors,
                        borderRadius: 4,
                        borderSkipped: false,
                        barThickness: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true, max: 100,
                            ticks: { callback: function(v) { return v + '%'; }, color: c.tickColor, font: { size: 9 } },
                            grid: { color: c.gridColor },
                            border: { display: false }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 11, weight: '500' } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: function(ctx) { return ctx.parsed.x + '% avg completion'; } }
                        }
                    }
                }
            });
        }

        // ---- SUCCESS PATTERNS: BEST DAY BAR CHART ----
        function buildBestDayChart() {
            var allCheckins = GN_getAllCheckins();
            var dayCounts = [0,0,0,0,0,0,0];
            var dayTotals = [0,0,0,0,0,0,0];
            for (var hid in allCheckins) {
                for (var dateStr in allCheckins[hid]) {
                    var parts = dateStr.split('-');
                    var dt = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    var dow = dt.getDay();
                    dayTotals[dow]++;
                    if (allCheckins[hid][dateStr] === 'complete') dayCounts[dow]++;
                }
            }

            var order = [1,2,3,4,5,6,0];
            var labels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            var rates = [];
            var bestIdx = -1, bestRate = -1;

            for (var i = 0; i < 7; i++) {
                var idx = order[i];
                var rate = dayTotals[idx] > 0 ? Math.round((dayCounts[idx] / dayTotals[idx]) * 100) : 0;
                rates.push(rate);
                if (rate > bestRate) { bestRate = rate; bestIdx = i; }
            }

            destroyChart('bestDay');
            var canvas = document.getElementById('chartBestDay');
            if (!canvas) return;

            if (bestRate <= 0) {
                canvas.parentElement.style.display = 'none';
                return;
            }
            canvas.parentElement.style.display = '';

            var c = chartColors();
            var bgColors = rates.map(function(r, i) { return i === bestIdx ? '#22c55e' : c.emptyBarBg; });
            var borderColors = rates.map(function(r, i) { return i === bestIdx ? '#22c55e' : c.emptyBarBorder; });

            chartInstances.bestDay = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: rates,
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 100, display: false },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 9, weight: '600' } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: function(ctx) { return ctx.parsed.y + '% completion'; } } },
                        communityAvgLine: { value: 71, label: 'Avg 71%' }
                    }
                }
            });

            var bestDayName = dayNames[order[bestIdx]];
            document.getElementById('spBestDayLabel').textContent = bestDayName + ' is your best day (' + bestRate + '% completion)';
        }

        // ---- SUCCESS PATTERNS: PENALTY IMPACT LINE CHART ----
        function buildPenaltyChart() {
            var habits = GN_getHabits();
            var points = [];

            habits.forEach(function(h) {
                var stats = GN_getHabitStats(h.id);
                if (!stats || stats.totalCheckins === 0) return;
                points.push({ x: h.penalty || 0, y: stats.completionRate, name: h.name });
            });

            destroyChart('penalty');
            var canvas = document.getElementById('chartPenalty');
            if (!canvas) return;

            if (points.length < 2) {
                canvas.parentElement.style.display = 'none';
                document.getElementById('spPenaltyLabel').textContent = points.length === 1 ?
                    'Need more habits with different penalties to show trend' : 'No habit data yet';
                return;
            }
            canvas.parentElement.style.display = '';

            points.sort(function(a, b) { return a.x - b.x; });
            var c = chartColors();
            var ctx = canvas.getContext('2d');
            var gradient = ctx.createLinearGradient(0, 0, 0, canvas.parentElement.offsetHeight || 120);
            gradient.addColorStop(0, 'rgba(230, 126, 34, 0.3)');
            gradient.addColorStop(1, 'rgba(230, 126, 34, 0)');

            chartInstances.penalty = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: points.map(function(p) { return '$' + p.x; }),
                    datasets: [{
                        data: points.map(function(p) { return p.y; }),
                        borderColor: '#E67E22',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#E67E22',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true, max: 100,
                            ticks: { callback: function(v) { return v + '%'; }, color: c.tickColor, font: { size: 8 }, stepSize: 50 },
                            grid: { color: c.gridColor },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 9 } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(items) { return points[items[0].dataIndex].name; },
                                label: function(ctx) { return 'Penalty: $' + points[ctx.dataIndex].x + ' | Completion: ' + ctx.parsed.y + '%'; }
                            }
                        },
                        communityAvgLine: { value: 71, label: 'Avg 71%' }
                    }
                }
            });

            var first = points[0].y, last = points[points.length - 1].y;
            var diff = last - first;
            if (diff > 5) {
                document.getElementById('spPenaltyLabel').textContent = 'Higher penalties correlate with +' + Math.round(diff) + '% completion';
            } else if (diff < -5) {
                document.getElementById('spPenaltyLabel').textContent = 'Lower penalties show ' + Math.abs(Math.round(diff)) + '% better completion';
            } else {
                document.getElementById('spPenaltyLabel').textContent = 'Penalty amount has minimal impact on your completion rate';
            }
        }

        // ---- SUCCESS PATTERNS: GOAL COMPLEXITY LINE CHART ----
        function buildComplexityChart() {
            var goals = GN_getGoals();
            var groups = {};

            goals.forEach(function(g) {
                if (g.status !== 'active' && g.status !== 'paused' && g.status !== 'completed') return;
                var gHabits = GN_getHabitsForGoal(g.id);
                var stats = GN_getGoalStats(g.id);
                if (!stats || !gHabits.length) return;
                var key = gHabits.length;
                if (!groups[key]) groups[key] = { totalRate: 0, count: 0 };
                groups[key].totalRate += stats.completionRate;
                groups[key].count++;
            });

            var points = [];
            for (var k in groups) {
                points.push({ x: parseInt(k), y: Math.round(groups[k].totalRate / groups[k].count) });
            }

            destroyChart('complexity');
            var canvas = document.getElementById('chartComplexity');
            if (!canvas) return;

            if (points.length < 2) {
                canvas.parentElement.style.display = 'none';
                document.getElementById('spComplexityLabel').textContent = points.length === 1 ?
                    'Need goals with different habit counts to show trend' : 'No goal data yet';
                return;
            }
            canvas.parentElement.style.display = '';

            points.sort(function(a, b) { return a.x - b.x; });
            var c = chartColors();
            var ctx = canvas.getContext('2d');
            var gradient = ctx.createLinearGradient(0, 0, 0, canvas.parentElement.offsetHeight || 120);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            chartInstances.complexity = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: points.map(function(p) { return p.x + (p.x === 1 ? ' habit' : ' habits'); }),
                    datasets: [{
                        data: points.map(function(p) { return p.y; }),
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true, max: 100,
                            ticks: { callback: function(v) { return v + '%'; }, color: c.tickColor, font: { size: 8 }, stepSize: 50 },
                            grid: { color: c.gridColor },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 9 } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) { return 'Completion: ' + ctx.parsed.y + '%'; }
                            }
                        },
                        communityAvgLine: { value: 71, label: 'Avg 71%' }
                    }
                }
            });

            var first = points[0].y, last = points[points.length - 1].y;
            var diff = first - last;
            if (diff > 5) {
                document.getElementById('spComplexityLabel').textContent = 'Simpler goals outperform complex ones by ' + Math.round(diff) + '%';
            } else if (diff < -5) {
                document.getElementById('spComplexityLabel').textContent = 'Complex goals outperform simpler ones by ' + Math.abs(Math.round(diff)) + '%';
            } else {
                document.getElementById('spComplexityLabel').textContent = 'Goal complexity has minimal impact on your completion rate';
            }
        }

        // ---- SUCCESS PATTERNS: GOAL TIMEFRAME LINE CHART ----
        function buildTimeframeChart() {
            var goals = GN_getGoals();
            var points = [];

            goals.forEach(function(g) {
                if (g.status !== 'active' && g.status !== 'paused' && g.status !== 'completed') return;
                var stats = GN_getGoalStats(g.id);
                if (!stats) return;
                var dur = g.duration > 0 ? g.duration : 0;
                if (dur === 0) return;
                points.push({ x: dur, y: stats.completionRate, name: g.name });
            });

            destroyChart('timeframe');
            var canvas = document.getElementById('chartTimeframe');
            if (!canvas) return;

            if (points.length < 2) {
                canvas.parentElement.style.display = 'none';
                document.getElementById('spTimeframeLabel').textContent = points.length === 1 ?
                    'Need goals with different durations to show trend' : 'No timed goal data yet';
                return;
            }
            canvas.parentElement.style.display = '';

            points.sort(function(a, b) { return a.x - b.x; });
            var c = chartColors();
            var ctx = canvas.getContext('2d');
            var gradient = ctx.createLinearGradient(0, 0, 0, canvas.parentElement.offsetHeight || 120);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0)');

            chartInstances.timeframe = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: points.map(function(p) {
                        return p.x <= 60 ? p.x + 'd' : Math.round(p.x / 30) + 'mo';
                    }),
                    datasets: [{
                        data: points.map(function(p) { return p.y; }),
                        borderColor: '#8b5cf6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true, max: 100,
                            ticks: { callback: function(v) { return v + '%'; }, color: c.tickColor, font: { size: 8 }, stepSize: 50 },
                            grid: { color: c.gridColor },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 9 } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(items) { return points[items[0].dataIndex].name; },
                                label: function(ctx) { return 'Duration: ' + points[ctx.dataIndex].x + 'd | Completion: ' + ctx.parsed.y + '%'; }
                            }
                        },
                        communityAvgLine: { value: 71, label: 'Avg 71%' }
                    }
                }
            });

            var first = points[0].y, last = points[points.length - 1].y;
            var diff = first - last;
            if (diff > 5) {
                document.getElementById('spTimeframeLabel').textContent = 'Shorter goals outperform longer ones by ' + Math.round(diff) + '%';
            } else if (diff < -5) {
                document.getElementById('spTimeframeLabel').textContent = 'Longer goals outperform shorter ones by ' + Math.abs(Math.round(diff)) + '%';
            } else {
                document.getElementById('spTimeframeLabel').textContent = 'Goal duration has minimal impact on your completion rate';
            }
        }

        // ---- COMMUNITY BENCHMARKS ----
        function buildBenchmarks() {
            var stats = GN_getOverallStats();
            var userRate = stats.overallCompletionRate || 0;

            // Simulated community data (will come from backend in Phase 1)
            var communityAvg = 71;
            var communityData = {
                topNiche: 'Fitness',
                topNicheRate: 81,
                avgPenalty: 5,
                bestTimeframe: '30 days',
                totalUsers: 1247
            };

            document.getElementById('benchmarkYou').textContent = userRate + '%';
            document.getElementById('benchmarkYou').style.color = userRate >= communityAvg ? '#22c55e' : '#ef4444';
            document.getElementById('benchmarkCommunity').textContent = communityAvg + '%';

            // Calculate percentile (simulated based on normal distribution around 71%)
            var diff = userRate - communityAvg;
            var percentile;
            if (diff >= 20) percentile = Math.max(5, 15 - Math.floor(diff / 5));
            else if (diff >= 10) percentile = Math.max(10, 25 - diff);
            else if (diff >= 0) percentile = Math.max(25, 50 - diff * 2.5);
            else if (diff >= -10) percentile = Math.min(75, 50 + Math.abs(diff) * 2.5);
            else percentile = Math.min(90, 75 + Math.abs(diff));
            percentile = Math.round(percentile);

            document.getElementById('benchmarkRank').textContent = userRate > 0 ?
                "You're in the top " + percentile + '% of ninjas' : 'Start tracking to see your ranking';

            // Tags based on user data
            var habits = GN_getHabits();
            var avgPenalty = 0;
            if (habits.length > 0) {
                var totalPen = 0;
                habits.forEach(function(h) { totalPen += h.penalty || 0; });
                avgPenalty = Math.round(totalPen / habits.length);
            }

            // Find user's top category
            var goals = GN_getGoals();
            var catRates = {};
            goals.forEach(function(g) {
                if (g.status !== 'active' && g.status !== 'paused') return;
                var cat = getCategoryForIcon(g.icon || 'target');
                var gs = GN_getGoalStats(g.id);
                if (gs) {
                    if (!catRates[cat]) catRates[cat] = { total: 0, count: 0 };
                    catRates[cat].total += gs.completionRate;
                    catRates[cat].count++;
                }
            });
            var topCat = 'General';
            var topCatRate = 0;
            for (var c in catRates) {
                var avg = catRates[c].total / catRates[c].count;
                if (avg > topCatRate) { topCatRate = avg; topCat = c; }
            }

            var tagStyle = 'font-size:10px;background:var(--bg);padding:4px 8px;border-radius:8px;color:var(--text-muted)';
            var tagsHtml = '<span style="' + tagStyle + '">Your avg penalty: $' + avgPenalty + '/day</span>' +
                '<span style="' + tagStyle + '">Top niche: ' + communityData.topNiche + ' (' + communityData.topNicheRate + '%)</span>' +
                '<span style="' + tagStyle + '">Your best: ' + topCat + '</span>';
            document.getElementById('benchmarkTags').innerHTML = tagsHtml;
        }

        // ---- HABIT DROP-OFF ANALYSIS ----
        function buildDropoff() {
            var allCheckins = GN_getAllCheckins();
            var habits = GN_getHabits();

            destroyChart('dropoff');
            var canvas = document.getElementById('chartDropoff');

            if (!habits.length) {
                if (canvas) canvas.parentElement.style.display = 'none';
                document.getElementById('dropoffInsight').textContent = 'Start tracking habits to see your drop-off patterns.';
                return;
            }

            var weekRates = {};
            habits.forEach(function(h) {
                var checkins = GN_getCheckinsForHabit(h.id);
                var dates = Object.keys(checkins).sort();
                if (dates.length === 0) return;
                var startDate = dates[0];

                for (var i = 0; i < dates.length; i++) {
                    var dayNum = GN_daysBetween(startDate, dates[i]) + 1;
                    var weekNum = Math.ceil(dayNum / 7);
                    if (weekNum > 8) continue;
                    if (!weekRates[weekNum]) weekRates[weekNum] = { completed: 0, total: 0 };
                    weekRates[weekNum].total++;
                    if (checkins[dates[i]] === 'complete') weekRates[weekNum].completed++;
                }
            });

            var maxWeek = 0;
            for (var w in weekRates) { if (parseInt(w) > maxWeek) maxWeek = parseInt(w); }
            maxWeek = Math.max(maxWeek, 4);

            var rates = [];
            for (var w = 1; w <= Math.min(maxWeek, 8); w++) {
                var wr = weekRates[w];
                rates.push(wr ? Math.round((wr.completed / wr.total) * 100) : 0);
            }

            if (!canvas) return;
            canvas.parentElement.style.display = '';
            var c = chartColors();
            var bgColors = rates.map(function(pct) { return pct >= 70 ? '#22c55e' : pct >= 40 ? '#E67E22' : '#ef4444'; });

            chartInstances.dropoff = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: rates.map(function(_, i) { return 'Wk ' + (i + 1); }),
                    datasets: [{
                        data: rates,
                        backgroundColor: bgColors,
                        borderRadius: { topLeft: 4, topRight: 4 },
                        borderSkipped: 'bottom'
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 100, display: false },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 9 } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: function(ctx) { return 'Week ' + (ctx.dataIndex + 1) + ': ' + ctx.parsed.y + '% completion'; } }
                        }
                    }
                }
            });

            var lowestWeek = 1, lowestRate = 100;
            for (var i = 0; i < rates.length; i++) {
                if (rates[i] < lowestRate && rates[i] > 0) { lowestRate = rates[i]; lowestWeek = i + 1; }
            }
            if (rates.length >= 2 && lowestRate < rates[0]) {
                document.getElementById('dropoffInsight').textContent = 'âš ï¸ Biggest drop: Week ' + lowestWeek + ' (' + lowestRate + '%) â€” stay vigilant around this point!';
            } else {
                document.getElementById('dropoffInsight').textContent = 'âœ… Great consistency! No major drop-off pattern detected.';
                document.getElementById('dropoffInsight').style.background = '#f0fdf4';
            }
        }

        // ---- TIMEFRAME ANALYSIS ----
        function buildTimeframe() {
            var goals = GN_getGoals();
            var buckets = {
                short: { totalRate: 0, count: 0 },
                medium: { totalRate: 0, count: 0 },
                long: { totalRate: 0, count: 0 }
            };

            goals.forEach(function(g) {
                if (g.status !== 'active' && g.status !== 'paused' && g.status !== 'completed' && g.status !== 'failed') return;
                var stats = GN_getGoalStats(g.id);
                if (!stats) return;
                if (g.duration > 0 && g.duration <= 30) { buckets.short.totalRate += stats.completionRate; buckets.short.count++; }
                else if (g.duration > 30 && g.duration <= 89) { buckets.medium.totalRate += stats.completionRate; buckets.medium.count++; }
                else { buckets.long.totalRate += stats.completionRate; buckets.long.count++; }
            });

            var data = [
                { label: 'Short', sub: 'â‰¤30d', rate: buckets.short.count > 0 ? Math.round(buckets.short.totalRate / buckets.short.count) : 0, count: buckets.short.count },
                { label: 'Medium', sub: '31-89d', rate: buckets.medium.count > 0 ? Math.round(buckets.medium.totalRate / buckets.medium.count) : 0, count: buckets.medium.count },
                { label: 'Long', sub: '90d+', rate: buckets.long.count > 0 ? Math.round(buckets.long.totalRate / buckets.long.count) : 0, count: buckets.long.count }
            ];

            destroyChart('timeframeAnalysis');
            var canvas = document.getElementById('chartTimeframeAnalysis');
            if (!canvas) return;

            var c = chartColors();
            var bgColors = data.map(function(d) {
                if (d.count === 0) return c.emptyBarBg;
                return d.rate >= 70 ? '#22c55e' : d.rate >= 40 ? '#E67E22' : '#ef4444';
            });
            var borderColors = data.map(function(d) { return d.count === 0 ? c.emptyBarBorder : 'transparent'; });

            chartInstances.timeframeAnalysis = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: data.map(function(d) { return d.label + '\n' + d.sub; }),
                    datasets: [{
                        data: data.map(function(d) { return d.count > 0 ? d.rate : 0; }),
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: data.map(function(d) { return d.count === 0 ? 1.5 : 0; }),
                        borderRadius: 6,
                        borderSkipped: false,
                        barPercentage: 0.5,
                        categoryPercentage: 0.6
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 100, display: false },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 10 } },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    var d = data[ctx.dataIndex];
                                    return d.count > 0 ? d.rate + '% (' + d.count + ' goals)' : 'No goals';
                                }
                            }
                        }
                    }
                }
            });

            var hasData = data.filter(function(d) { return d.count > 0; });
            if (hasData.length >= 2) {
                hasData.sort(function(a, b) { return b.rate - a.rate; });
                var best = hasData[0], worst = hasData[hasData.length - 1];
                var diff = best.rate - worst.rate;
                document.getElementById('timeframeInsight').textContent = best.label + '-term goals outperform ' + worst.label.toLowerCase() + '-term by ' + diff + '% (' + best.count + ' vs ' + worst.count + ' goals)';
            } else if (hasData.length === 1) {
                document.getElementById('timeframeInsight').textContent = 'All your goals are ' + hasData[0].label.toLowerCase() + '-term. Add different durations to compare!';
            } else {
                document.getElementById('timeframeInsight').textContent = 'Create goals to see timeframe performance comparison.';
            }
        }

        // ---- GOAL DROP-OFF POINTS ----
        function buildGoalDropoff() {
            var goals = GN_getGoals();
            var allCheckins = GN_getAllCheckins();

            var weekData = {};
            var maxDuration = 0;

            goals.forEach(function(g) {
                if (!g.startDate) return;
                var gHabits = GN_getHabitsForGoal(g.id);
                if (!gHabits.length) return;

                var dur = g.duration > 0 ? g.duration : 60;
                if (dur > maxDuration) maxDuration = dur;

                gHabits.forEach(function(h) {
                    var checkins = GN_getCheckinsForHabit(h.id);
                    for (var dateStr in checkins) {
                        if (dateStr < g.startDate) continue;
                        var dayNum = GN_daysBetween(g.startDate, dateStr) + 1;
                        if (g.duration > 0 && dayNum > g.duration) continue;
                        var weekNum = Math.ceil(dayNum / 7);
                        if (!weekData[weekNum]) weekData[weekNum] = { completed: 0, total: 0 };
                        weekData[weekNum].total++;
                        if (checkins[dateStr] === 'complete') weekData[weekNum].completed++;
                    }
                });
            });

            var maxWeeks = Math.min(Math.ceil(maxDuration / 7), 12);
            maxWeeks = Math.max(maxWeeks, 4);

            destroyChart('goalDropoff');
            var canvas = document.getElementById('chartGoalDropoff');

            if (Object.keys(weekData).length === 0) {
                if (canvas) canvas.parentElement.style.display = 'none';
                document.getElementById('goalDropoffInsight').textContent = 'Start goals to see where drop-offs happen.';
                return;
            }

            if (canvas) canvas.parentElement.style.display = '';
            var rates = [];
            for (var w = 1; w <= maxWeeks; w++) {
                var wd = weekData[w];
                var pct = wd ? Math.round((wd.completed / wd.total) * 100) : 0;
                rates.push({ week: w, rate: pct, hasData: !!wd });
            }

            var c = chartColors();
            var bgColors = rates.map(function(r) {
                if (!r.hasData) return 'rgba(200,200,200,0.3)';
                return r.rate >= 70 ? '#22c55e' : r.rate >= 40 ? '#E67E22' : '#ef4444';
            });

            chartInstances.goalDropoff = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: rates.map(function(r) { return 'Wk ' + r.week; }),
                    datasets: [{
                        data: rates.map(function(r) { return r.rate; }),
                        backgroundColor: bgColors,
                        borderRadius: { topLeft: 3, topRight: 3 },
                        borderSkipped: 'bottom'
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 100, display: false },
                        x: {
                            grid: { display: false },
                            ticks: { color: c.tickColor, font: { size: 8 }, autoSkip: true, maxTicksLimit: 6 },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return rates[ctx.dataIndex].hasData ?
                                        'Week ' + rates[ctx.dataIndex].week + ': ' + ctx.parsed.y + '%' : 'No data';
                                }
                            }
                        }
                    }
                }
            });

            var biggestDrop = 0, dropWeek = 0;
            for (var i = 1; i < rates.length; i++) {
                if (rates[i].hasData && rates[i-1].hasData) {
                    var drop = rates[i-1].rate - rates[i].rate;
                    if (drop > biggestDrop) { biggestDrop = drop; dropWeek = rates[i].week; }
                }
            }

            if (biggestDrop > 10) {
                document.getElementById('goalDropoffInsight').textContent = 'âš ï¸ Biggest drop: Week ' + dropWeek + ' (âˆ’' + biggestDrop + '%). Plan extra motivation around this point!';
            } else if (rates.length > 1) {
                document.getElementById('goalDropoffInsight').textContent = 'âœ… Solid consistency! No major goal drop-off detected.';
                document.getElementById('goalDropoffInsight').style.background = '#f0fdf4';
            } else {
                document.getElementById('goalDropoffInsight').textContent = 'More data needed to identify drop-off patterns.';
            }
        }

        // ---- INIT ----
        function initAnalytics() {
            GN_checkAndUpdateStatuses();

            var stats = GN_getOverallStats();

            // Banner
            document.getElementById('bannerRate').textContent = (stats.overallCompletionRate || 0) + '%';
            document.getElementById('bannerStreak').textContent = stats.bestStreak || 0;
            document.getElementById('bannerSavings').textContent = '$' + (stats.totalVault || 0).toFixed(0);

            // Consistency Score
            var score = calculateConsistencyScore();
            document.getElementById('bannerScore').textContent = score;
            document.getElementById('scoreNumber').textContent = score;

            // Score ring
            var circumference = 2 * Math.PI * 42; // r=42
            var filled = circumference * (score / 100);
            var ringFill = document.getElementById('scoreRingFill');
            var ringColor = score > 70 ? '#22c55e' : score > 40 ? '#E67E22' : '#ef4444';
            ringFill.setAttribute('stroke', ringColor);
            ringFill.setAttribute('stroke-dasharray', filled + ' ' + circumference);

            // Score trend
            var trendEl = document.getElementById('scoreTrend');
            if (score > 70) { trendEl.className = 'score-trend up'; trendEl.textContent = 'â†‘ Great momentum'; }
            else if (score > 40) { trendEl.className = 'score-trend neutral'; trendEl.textContent = 'â€” Building consistency'; }
            else { trendEl.className = 'score-trend down'; trendEl.textContent = 'â†“ Room to improve'; }

            // Build visualizations
            buildHeatmap();
            buildSparkline();
            buildHabitBars();
            buildStreaks();
            buildGoalProgress();
            buildCategories();
            buildBestDayChart();
            buildPenaltyChart();
            buildComplexityChart();
            buildTimeframeChart();
            buildBenchmarks();
            buildDropoff();
            buildTimeframe();
            buildGoalDropoff();
        }

        initAnalytics();

        // Re-render charts on theme change
        window.addEventListener('storage', function(e) {
            if (e.key === 'goalNinjaAppearance') {
                setTimeout(function() { rebuildAllCharts(); }, 100);
            }
        });

        // NinjaBuddy analytics greeting
        setTimeout(function() {
            if (!window.NinjaBuddy) return;
            var score = calculateConsistencyScore();
            var msg;
            if (score >= 80) { msg = 'Consistency score of ' + score + ' â€” that\'s ninja-level discipline!'; NinjaBuddy.setPose('fistpump'); }
            else if (score >= 50) { msg = 'Score of ' + score + '. You\'re building solid habits â€” keep pushing!'; NinjaBuddy.setPose('checklist'); }
            else if (score > 0) { msg = 'Score of ' + score + '. Every ninja starts somewhere â€” let\'s build momentum!'; NinjaBuddy.setPose('target'); }
            else { msg = 'Start tracking your habits to see your analytics come alive!'; NinjaBuddy.setPose('wave'); }
            window.NinjaBuddy.say(msg, 5000);
        }, 1500);
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('../sw.js');
    }
    </script>
</body>
</html>
